{"version":3,"sources":["static/assets/images/logo-est.png","static/assets/tara/tara-logo-et.png","logo.svg","process/Base.tsx","postMessage.tsx","i18n.ts","components/LogRows.tsx","components/MessageLog.tsx","components/Process.tsx","byNameStore.tsx","components/Arena.tsx","components/SendButton.tsx","process/Counter.tsx","components/Popup.tsx","components/Client.tsx","process/TokenRing.tsx","process/client/types.tsx","process/consentService/types.tsx","util.tsx","process/consentService/declarationAPI.tsx","process/consentService/ui.tsx","process/consentService/referenceAPI.tsx","process/serviceProvider/types.tsx","process/consentService/validationAPI.tsx","process/consentService/reportingAPI.tsx","process/serviceProvider/messages.tsx","process/client/messages.tsx","process/client/EnduserUI.tsx","process/client/views.tsx","process/client/constructor.tsx","process/consentService/constructor.tsx","process/consentService/views.tsx","process/serviceProvider/views.tsx","process/serviceProvider/constructor.tsx","config.tsx","components/Theatre.tsx","process/consentService/altUI/backendAPI.tsx","components/veera/footer.tsx","components/veera/header.tsx","components/veera/layout.tsx","components/tabs/Tab.tsx","components/tabs/Tabs.tsx","process/consentService/altUI/ConsentModal.tsx","process/consentService/altUI/MyConsents.tsx","process/consentService/altUI/ConsentHistory.tsx","process/consentService/altUI/CSEnduserUI.tsx","process/consentService/altUI/ria.tsx","App.tsx","serviceWorker.ts","store.tsx","index.tsx","static/assets/images/user-icon.svg","static/assets/images/login.svg"],"names":["module","exports","MESSAGE","handlers","addHandlerClass","impl","c","handler","type","undefined","addHandler","name","p","a","handle","obj","values","createMessage","message","arena","sender","receivers","length","GenericMessageHandler","this","process","action","mem","updateMem","queue","concat","payload","send","error","extra","withResponse","response","uiMap","addUi","url","defaultRender","JSON","stringify","renderers","addRenderer","view","renderer","updateDb","newdb","db","STATE_UPDATE","INITIALIZED","StateUpdateMessage","statusUpdateChannel","StateUpdater","store","ui","_cachedState","_storeUnsubscriber","_messageListener","_channel","URL","window","location","href","open","Math","random","subscribe","stateChanged","processMessage","addEventListener","removeEventListener","state","ps","theatre","arenas","byName","selectProcess","getState","postMessage","origin","e","console","unregisterListeners","msg","data","dispatch","registeredUpdaters","BackendStateUpdater","setter","caster","log","ev","receiveNewState","newState","withUpdater","target","opener","channelId","Object","assign","setState","BackendAPI","updater","m","split","i18n","use","Backend","LanguageDetector","initReactI18next","init","fallbackLng","debug","interpolation","escapeValue","__","props","labels","suffix","join","proc","t","map","pref","styleNameFor","fullname","id","prop","replace","person","business","formatProcess","className","formatProcessList","names","r","i","formatBody","max","key","value","substring","defaultRenderer","owner","formatHeader","LogRow","showPopup","onClick","findLogRenderer","addLogRenderers","keys","forEach","addLogRenderer","LogView","filterFn","includes","showSelf","index","_this","show","onHide","closePopup","size","Body","Footer","Button","variant","logLines","rows","filter","slice","maxRows","popup","line","formatLogLine","React","MessageLog","connect","ownProps","selectArena","LogButton","Header","Title","ModalFooter","children","render","findRenderer","ProcessUI","preventDefault","alert","UILink","button","useStore","launch","push","registerListeners","launchUI","el","addByName","old","allNames","n","reduceByName","reducer","k","fromArray","reduce","MESSAGE_DELAY","createProcess","reduceProcesses","CREATE_PROCESS","FLUSH_QUEUE","reduceArena","reduceMessage","queueListener","queued","flat","d","getQueued","setTimeout","delayedSender","shift","now","Date","Arena","useTranslation","processes","role","parseOrRaw","s","startsWith","parse","f","Array","from","elements","u","out","options","selected","checked","o","Send","messageToAction","currentTarget","form","handleClick","title","text","SimpleSend","Counter","CounterDefaultView","IncrementMessageHandler","DecrementMessageHandler","incrementMessage","decrementMessage","Popup","LOGIN","alt","src","require","ClientView","loading","changeView","aria-hidden","width","TokenNode","WithToken","WithoutToken","createTokenNode","next","token","initPassMessage","node","tokenMessage","updateNextMessage","SetTargetPopup","setShow","handleClose","handleShow","closeButton","htmlFor","readOnly","multiple","defaultValue","bsPrefix","Client","ClientIS","ClientDefaultView","ConsentService","ConsentServiceDefaultView","findFrom","items","example","find","hash","input","createHash","update","digest","address2org","address","match","renderText","stack","last","indent","l","prefix","pop","ul","addServiceDeclaration","cs","sd","serviceDeclarations","decl","serviceProviderId","serviceDeclarationId","withErrorResponse","withOkResponse","addPurposeDeclaration","pd","purposeDeclarations","clientId","purposeDeclarationId","services","sdRef","loginMessage","user","giveConsentMessage","con","consents","newConsent","dataSubject","revoked","updatedCS","addConsent","activeUser","activePurposeDeclaration","updatedCS2","setActivePD","callbackURL","fetchConsentReference","revokeConsentMessage","ref","consentReference","validUntil","revokeAt","revokeIfReferenceEquals","revokeConsent","updateAPDforUser","refs","activatePurposeDeclarationMessage","ConsentReferenceResponseTypeName","fixRevoked","getConsentReference","req","_cs","consent","subjectId","ServiceProviderIS","ServiceProviderDefaultView","requestTypeName","responseTypeName","ValidationResponseTypeName","NotValidResponse","asyncId","valid","validateConsentReference","notValid","validFrom","purposeDeclaration","consentExpiration","toISOString","dataSubjectId","reportServiceUse","usageLog","addUsageRecord","addData","spis","datatype","rec","dbrec","subject","declareService","consentService","requestId","service","requestReference","serviceName","submitRequest","_send","report","result","serviceDeclarationIds","requiredServiceDeclarationIds","usageTime","clientAddress","reqState","validationRequestId","withInfligh","inflight","partyId","ifr","resp","removeInflight","usageReport","submitResponse","records","x","returnedDatatypes","selectServiceMessage","cachedConsentRefs","consentRefByUser","cachedConsentRef","consentServiceId","declarePurpose","cis","updateCSRef","csByUser","executeRequest","userConsentRefs","purposeId","conf","config","serviceAddress","_cis","newResponses","requestReferenceId","__cis","generateRequestReference","dumpConsentRefCache","validateConsentRef","SELECT_SERVICE","WAIT_FOR_CONSENT_REF","CONSENT_NOT_FOUND","SERVICE_V1","currentView","ClientView_","sendMessagesFor","withMessages","componentDidUpdate","actualView","returnButton","dangerouslySetInnerHTML","__html","EnduserUI","DeclarePurposePopup","sp","setOpts","useState","sdrefs","setSDRefs","declTemplate","onChange","decls","declId","description","prefillPurposeDeclaration","dt","sdref","placeholder","opts","spId","_spId","sdId","_sdId","addSDRef","hasUser","consentRefCount","purpose","countConsentRefs","responseCount","consentRef","consentRefDesc","purposeView","updateMaxDuration","v","declarationPrefill","technicalDescription","needSignature","md","consentMaxDurationSeconds","prefillServiceDeclaration","DeclareServicePopup","allValues","sort","CS1Address","defaultArena","createServiceProvider","createData","diagnoos","arst","uuring","vastus","haigus","preparaat","seeria","jrk","uuesti","createConsentService","logRenderers","createCounter","initialTheatre","createArena","active","SELECT_ARENA","_Theatre","PureComponent","Theatre","ConsentServiceBackend","post","getServiceDeclaration","getValidUntil","floor","getConsents","ur","candidate","expiresIn","Number","CSBackend","createContext","ctx","useContext","rel","backendUse","backend","login","VeeraLayout","Tab","label","activeTab","style","cursor","Component","Tabs","onClickTabItem","tab","child","ConsentModal","buttonText","dec","rowView","formatTimestamp","isConsentActive","handleRevoke","MyConsents","Table","header","consentDescription","ConsentHistory","getUsageLogRecords","usageRecordDescription","Modal","ActivePurposeDeclaration","signPopup","returnPopup","showConsentTab","bind","savedClientId","tabRef","current","toggleSignPopup","giveConsentByPurpose","activeDecl","showReturnPopup","close","ReturnScreen","Popover","MainView","getActivePurposeDeclaration","CSEnduserUI","context","backendLink","csb","createRef","document","body","classList","add","resetState","Provider","timestamp","withTime","Intl","DateTimeFormat","year","month","day","hour","minute","second","format","Ria","aria-label","data-tab","click","version","xmlns","viewBox","Page","changeLanguage","lng","path","language","Loader","App","fallback","Boolean","hostname","rootReducer","combineReducers","middlewares","thunkMiddleware","middleWareEnhancer","applyMiddleware","createStore","composeWithDevTools","su","source","registerGlobalListener","configureStore","ReactDOM","getElementById","navigator","serviceWorker","ready","then","registration","unregister"],"mappings":"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","file":"static/js/main.dc18772c.chunk.js","sourcesContent":["module.exports = __webpack_public_path__ + \"static/media/logo-est.bca08fff.png\";","module.exports = __webpack_public_path__ + \"static/media/tara-logo-et.5947b56d.png\";","module.exports = __webpack_public_path__ + \"static/media/logo.25bf045c.svg\";","import { AnyAction } from 'redux';\n\nexport type InstanceName = string;\nexport type ProcessImplName = string;\nexport type ViewName = string;\n\n// state\n\nexport interface ProcessState<S> {\n\tname: string; // instantsi nimi\n\ttitle: string;\n\ttype: ProcessImplName; // implementatsiooni nimi?\n\tview: ViewName; // \"olek\", tegelikult defineerib vaate\n\tmem: S; // sisuline olek\n\tqueue: Message<any>[]; // outbound queue, reduceritest kasutamiseks?\n}\n\n// sõnumi-action\n\nexport const MESSAGE = \"Process/SEND_MESSAGE\";\n\nexport interface Message<PL extends Payload> extends AnyAction {\n\ttype: typeof MESSAGE;\n\tarena: string;\n\tsender: string;\n\treceivers: string[];\n\tmessage: PL;\n\tnow?: number;\n\trandom?: string;\n}\n\nexport interface Payload {\n\ttype: string;\n}\n\nexport interface ErrorPayload extends Payload {\n\ttype: \"error\";\n\terror: string;\n}\n\nexport interface OKPayload extends Payload {\n\ttype: \"ack\"\n\tresponse: \"OK\";\n}\n\nexport type MessageHandler<S, M extends Payload> = (process: ProcessState<S>, action: Message<M>) => ProcessState<S>;\n\nconst handlers : { [impl: string] : { [type: string]: MessageHandler<any, any> } } = {};\n\nexport function addHandler<P extends Payload>(impl: ProcessImplName, type: string, handler: MessageHandler<any, P>) {\n\tif (handlers[impl] === undefined) {\n\t\thandlers[impl] = {};\n\t}\n\n\thandlers[impl][type] = handler;\n}\n\nexport function addHandlerClass<P extends Payload, T extends GenericMessageHandler<any, ProcessState<any>, P, T>>(impl: ProcessImplName, c: { new(): T }) {\n\tlet handler = new c();\n\taddHandler<P>(impl, handler.name, (p, a) => handler.handle(p, a));\n\treturn (obj?: Partial<P>) => ( (values?: Partial<P>) => handler.createMessage({...(values === undefined ? {} : values), ...(obj === undefined ? {} : obj)}) );\n}\n\nexport function reduceMessage<T>(process: ProcessState<T>, action: Message<Payload>): ProcessState<T> {\n\t//\tconsole.log(`reduceMessage ${JSON.stringify(process)}, ${JSON.stringify(action)}`);\n\tif (action.type !== MESSAGE || !action.receivers.includes(process.name)) {\n\t\treturn process;\n\t}\n\n\tif (handlers[process.type] === undefined) {\n\t\tconsole.error(`No handler for ${process.name} (${process.type})`);\n\t\treturn process;\n\t}\n\n\tif (handlers[process.type][action.message.type] === undefined) {\n\t\tconsole.error(`No handler for ${process.name} (${process.type}) for message ${action.message.type} (${JSON.stringify(action.message)})`);\n\t\treturn process;\n\t}\n\n\treturn handlers[process.type][action.message.type](process, action);\n}\n\nexport function message<M extends Payload>(arena: string, sender: ProcessState<any>, receivers: string[], message: M): Message<M> {\n\treturn { \n\t\ttype: MESSAGE,\n\t\tarena: arena,\n\t\tsender: sender.name, \n\t\treceivers: receivers.length === 0 ? [sender.name] : receivers,\n\t\tmessage: message\n\t};\n}\n\nexport abstract class GenericMessageHandler<S, PS extends ProcessState<S>, M extends Payload, GMH extends GenericMessageHandler<S, PS, M, GMH>> {\n\tabstract name: string;\n\n\tcreateMessage(obj: any): (M & { type: GMH[\"name\"] }) { return { ...obj, type: this.name }; };\n\thandle(process: PS, action: Message<M>): PS { return { ...process, mem: this.updateMem(process.mem, action) }; };\n\tupdateMem(mem: S, action: Message<M>): S { return mem; };\n\n\tsend<NM extends Payload>(process: PS, message: Message<NM>): PS {\n\t\treturn { ...process, queue: process.queue.concat(message) };\n\t}\n\n\twithResponse<NM extends Payload>(process: PS, action: Message<M>, payload: NM): PS {\n\t\treturn this.send(process, message<NM>(action.arena, process, [action.sender], payload));\n\t}\n\n\twithErrorResponse(process: PS, action: Message<M>, error: string, extra?: any) {\n\t\treturn this.withResponse<ErrorPayload>(process, action, { type: \"error\", error: error, ...extra });\n\t}\n\n\twithOkResponse(process: PS, action: Message<M>) {\n\t\treturn this.withResponse<OKPayload>(process, action, { type: \"ack\", response: \"OK\"});\n\t}\n\t\n}\n\n\n// UId\nexport const uiMap : { [type: string /* ProcessImplName */]: string /* URL */ } = {};\n\nexport function addUi(impl: ProcessImplName, url: string) {\n\tuiMap[impl] = url;\n}\n\n// renderdus\n\nexport interface ProcessAndArena<S> {\n\tprocess: ProcessState<S>;\n\tarena: string;\n}\n\nexport type ProcessRenderer<S> = React.FC<ProcessAndArena<S>> | ((props: ProcessAndArena<S>) => string);\n\nconst defaultRender: ProcessRenderer<any> = ({process} : ProcessAndArena<any>) => JSON.stringify(process.mem);\n\nconst renderers : { [impl: string /* ProcessImplName */]: { [view: string /* ViewName */]: ProcessRenderer<any> } } = {};\n\nexport function addRenderer(impl: ProcessImplName, view: ViewName, renderer: ProcessRenderer<any>) {\n\tif (renderers[impl] === undefined) {\n\t\trenderers[impl] = {};\n\t}\n\n\trenderers[impl][view] = renderer;\n}\n\nexport function findRenderer<S>(process: ProcessState<S>): ProcessRenderer<S> {\n\tif (renderers[process.type] === undefined) {\n\t\tconsole.error(`No renderer for ${process.type}`);\n\t\treturn defaultRender;\n\t}\n\n\tif (renderers[process.type][process.view] === undefined) {\n\t\tconsole.error(`No renderer for ${process.type} and view ${process.view}`);\n\t\treturn defaultRender;\n\t}\n\n\treturn renderers[process.type][process.view];\n}\n\nexport function updateMem<S>(process: ProcessState<S>, mem: Partial<S>): ProcessState<S> {\n\treturn { ...process, mem: { ...process.mem, ...mem }};\n}\n\nexport function updateDb<T, S extends ({ db: T; })>(process: ProcessState<S>, newdb: Partial<T>): ProcessState<S> {\n\treturn updateMem<S>(process, { db: { ...process.mem.db, ...newdb} } as Partial<S>);\n}","import { Store } from 'redux';\nimport { InstanceName, ViewName, MESSAGE, Message, Payload } from './process/Base';\nimport { AppState } from './store';\n\nexport const STATE_UPDATE = \"STATE_UPDATE\";\nexport const INITIALIZED = \"INITIALIZED\";\n\ntype MessagingTarget = Window | ServiceWorker | null;\n\nexport class StateUpdateMessage<P> {\n    type!: typeof STATE_UPDATE;\n    view!: ViewName;\n    mem?: P;\n    statusUpdateChannel?: number;\n}\n\nfunction selectProcess(state: AppState, arena: string, process: InstanceName): StateUpdateMessage<any> {\n    let ps = state.theatre.arenas.byName[arena].process.byName[process];\n    if (ps === undefined) {\n        // no such process?\n        return { type: STATE_UPDATE, view: \"\" };\n    }\n    return { type: STATE_UPDATE, view: ps.view, mem: ps.mem}\n}\n\nclass StateUpdater {\n    arena: string;\n    process: InstanceName;\n    store: Store;\n    url: URL;\n    ui: MessagingTarget;\n\n    _cachedState: any;\n    _storeUnsubscriber: any = null;\n    _messageListener: ((message: MessageEvent) => any) | null = null;\n    _channel: number;\n\n    constructor(arena: string, process: InstanceName, store: Store, url: string, ui?: MessagingTarget) {\n        this.arena = arena;\n        this.process = process;\n        this.store = store;\n        this.url = new URL(url, window.location.href);\n        if (ui === undefined) {\n            this.ui = window.open(url, `${arena} - ${process}`);\n        } else {\n            this.ui = ui;\n        }\n        this._channel = Math.random();\n    }\n\n    registerListeners() {\n        this._storeUnsubscriber = this.store.subscribe(() => { this.stateChanged(); })\n        this._messageListener = (message) => { this.processMessage(message); };\n        window.addEventListener(\"message\", this._messageListener);\n        return this;\n    }\n\n    unregisterListeners() {\n        this._storeUnsubscriber();\n        this._storeUnsubscriber = null;\n\n        if (this._messageListener !== null) {\n            window.removeEventListener(\"message\", this._messageListener);\n            this._messageListener = null;\n        }\n\n        return this;\n    }\n\n    stateChanged() {\n        let state = selectProcess(this.store.getState(), this.arena, this.process);\n        if (state !== this._cachedState) {\n            // postMessage originiga, mis ei ole \"*\" ei tööta ffga?\n            // https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage#Example lõpp\n            try { \n            this.ui!.postMessage({...state, statusUpdateChannel: this._channel}, this.url.origin);\n            } catch (e) {\n                console.error(\"Error posting message, stopping\", e);\n                this.unregisterListeners();\n            }\n            this._cachedState = state;\n        }\n        return this;\n    }\n\n    processMessage(msg: MessageEvent): void {\n        switch (msg.data.type) {\n            case INITIALIZED:\n                this._cachedState = undefined; // force state update\n                this.stateChanged();\n                return;\n\n            default:\n                if (msg.data.statusUpdateChannel !== this._channel) {\n                    // not for us. \n                    return;\n                }\n\n                // only messages to self.\n                this.store.dispatch({ \n                    type: MESSAGE, \n                    arena: this.arena,\n                    sender: this.process,\n                    receivers: [this.process],\n                    message: { ...msg.data, statusUpdateChannel: undefined },\n                } as Message<Payload>);\n        }\n    }\n}\n\nconst registeredUpdaters : StateUpdater[] = [];\n\nexport function registerGlobalListener(store: Store) {\n    window.addEventListener(\"message\", ev => {\n        if (ev.data.type === INITIALIZED) {\n            let [arena, process] = ev.data.target.split(' - ');\n            let url = ev.data.url;\n            if (registeredUpdaters.find(su => su.arena === arena && su.process === process && su.ui === ev.source) === undefined) {\n                console.log(\"Unregistered childwindow, registering: \", ev.data);\n                registeredUpdaters.push(\n                    new StateUpdater(arena, process, store, url, ev.source as Window)\n                    .registerListeners()\n                    .stateChanged()\n                );\n                ev.preventDefault();\n            }\n        }\n    });\n}\n\nexport function launchUI(arena: string, process: InstanceName, url: string, store: Store) {\n    registeredUpdaters.push(new StateUpdater(arena, process, store, url).registerListeners());\n}\n\n\nexport class BackendStateUpdater<S, C extends BackendAPI<S>> {\n    state!: StateUpdateMessage<S>;\n\n    setter: (newState: BackendAPI<S>) => void;\n    caster: { new(s: StateUpdateMessage<S>): C };\n\n    constructor(setter: (newState: BackendAPI<S>) => void, caster: { new(s: StateUpdateMessage<S>): C }) {\n        this.setter = setter;\n        this.caster = caster;\n        console.log(\"setting listener\");\n        window.addEventListener(\"message\", (ev) => { this.receiveNewState(ev); });\n    }\n\n    setState(newState: StateUpdateMessage<S>) {\n        console.log(\"updating state:\", newState);\n        this.state = newState;\n        this.setter(new this.caster(newState).withUpdater(this));\n    }\n\n    resetState() {\n        this.postMessage(INITIALIZED, { target: window.name, url: window.location.href });\n    }\n\n    postMessage(type: string, message?: any) {\n        if (window.opener === null) {\n            this.setState({ type: STATE_UPDATE, view: \"\", mem: { \"error\": \"NO OPENER WINDOW\"}} as any);\n            return;          \n        }\n\n        const channelId = this.state !== undefined ? { statusUpdateChannel: this.state.statusUpdateChannel } : {};\n\n        let msg = Object.assign({}, (message === undefined ? {} : message), { type }, channelId);\n        console.log(\"posting message:\", msg);\n        window.opener.postMessage(msg);\n    }\n\n    receiveNewState(ev: MessageEvent) {\n        if (ev.data.type === STATE_UPDATE) {\n            this.setState(ev.data);\n        }\n    }\n}\n\nexport class BackendAPI<S> extends StateUpdateMessage<S> {\n    updater!: BackendStateUpdater<S, BackendAPI<S>>;\n\n    constructor(msg?: StateUpdateMessage<S>) {\n        super();\n        Object.assign(this, msg);\n    }\n\n    withUpdater(updater: BackendStateUpdater<S, BackendAPI<S>>) {\n        this.updater = updater;\n        return this;\n    }\n\n    post(msg: () => Payload) {\n        let m = msg();\n        this.updater.postMessage(m.type, m);\n    }  \n\n\n    arena(): string {\n        return window.name.split(\" - \")[0];\n    }\n}\n","import i18n from 'i18next';\nimport Backend from 'i18next-xhr-backend';\nimport LanguageDetector from 'i18next-browser-languagedetector';\nimport { initReactI18next } from 'react-i18next';\nimport { ProcessAndArena, ProcessState } from './process/Base';\n\ni18n\n  // load translation using xhr -> see /public/locales\n  // learn more: https://github.com/i18next/i18next-xhr-backend\n  .use(Backend)\n  // detect user language\n  // learn more: https://github.com/i18next/i18next-browser-languageDetector\n  .use(LanguageDetector)\n  // pass the i18n instance to react-i18next.\n  .use(initReactI18next)\n  // init i18next\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    fallbackLng: 'et',\n    debug: process.env.NODE_ENV !== \"production\",\n\n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n  });\n\nexport default i18n;\n\nexport function _(...labels: string[]): string {\n  return i18n.t(labels.join(\".\"));\n}\n\nexport function __(props: ProcessAndArena<any>, ...labels: string[]): string {\n  const suffix = labels.join(\".\");\n  const arena = props.arena;\n  const proc = props.process.name;\n  const impl = props.process.type;\n  return i18n.t([\n    [ arena, proc ],\n    [ arena, impl ],\n    [ impl ],\n    []\n  ].map(pref => pref.concat(suffix).join(\".\")));\n}\n\nexport function styleNameFor(arena: string, name: string, type?: string): string {\n  return __({ arena: arena, process: { name: name, type: type! } as ProcessState<any> }, \"stylename\");\n}\n\nexport function person(id: string, prop: string): string {\n  return i18n.t([`person.${id}.${prop}`, `person.default.${prop}`]).replace(\"ISIKUKOOD\", id);\n}\n\nexport function fullname(id: string): string {\n  return person(id, \"name\");\n}\n\nexport function business(id: string, prop: string): string {\n  return i18n.t(`business.${id}.${prop}`);\n}\n","import { Message, ProcessState, Payload } from \"../process/Base\";\nimport React from \"react\";\nimport { styleNameFor } from \"../i18n\";\n\n\nexport function receivers(receivers: string[]) {\n    return receivers.length === 1 ? receivers[0] : `(${receivers.join(\", \")})`;\n}\n\nfunction formatProcess(arena: string, name: string) {\n    return (<span className={`msg-${ styleNameFor(arena, name) }`}>\n        { name }\n    </span>)\n}\n\nfunction formatProcessList(arena: string, names: string[]) {\n    if (names.length === 1) {\n        return formatProcess(arena, names[0]);\n    } else {\n        return (<>({ names.map(\n            (r, i) => (\n                <>{ i === 0 ? \", \" : undefined }{ formatProcess(arena, r) }</>\n            )\n        ) })</>)\n    }\n}\n\nfunction formatHeader(msg: Message<Payload>, owner?: ProcessState<any>) {\n\tif (owner === undefined) {\n\t\treturn (\n            <>\n            { formatProcess(msg.arena, msg.sender) }\n            <span> » </span>\n            { formatProcessList(msg.arena, msg.receivers) }\n            </>\n        )\n\t} else {\n        return (\n            (msg.sender === owner.name) \n                ? <><span>» </span>{ formatProcessList(msg.arena, msg.receivers) }</>\n                : <><span>« </span>{ formatProcess(msg.arena, msg.sender) }</>\n        );\n\t}\n}\n\nfunction cutJson(max: number) {\n    return (key: string, value: any) => (\n        typeof value !== \"string\" \n            ? value \n            : (value.length > max ? value.substring(0, max) + \"...\" : value)\n        );\n}\n\nfunction formatBody<M extends Payload>(msg: M) {\n\treturn `${msg.type}: ${JSON.stringify({ ...msg, type: undefined, statusUpdateChannel: undefined }, cutJson(40), \"  \")}`;\n}\n\nfunction defaultRenderer(arena: string, msg: Message<any>, owner?: ProcessState<any>) {\n    return (<>{formatHeader(msg, owner)}: {formatBody(msg.message)}</>);\n}\n\nexport function LogRow(arena: string, i: number, msg: Message<any>, owner: (ProcessState<any> | undefined), showPopup: (msg: Message<any>) => void) {\n    return (<span onClick={ev => showPopup(msg)}>\n        { findLogRenderer(arena, msg)(arena, msg, owner) }\n    </span>);\n}\n\nexport type LogRenderer = (arena: string, msg: Message<any>, owner?: ProcessState<any>) => any;\nconst renderers : { [arena: string]: { [type: string]: LogRenderer } } = {};\n\nfunction findLogRenderer(arena: string, msg: Message<any>): LogRenderer {\n    if (renderers[arena] === undefined) {\n        return defaultRenderer;\n    }\n\n    if (renderers[arena][msg.message.type] === undefined) {\n        return defaultRenderer;\n    }\n\n    return renderers[arena][msg.message.type];\n}\n\nexport function addLogRenderer(arena: string, type: string, renderer: LogRenderer) {\n    if (renderers[arena] === undefined) {\n        renderers[arena] = {};\n    }\n\n    renderers[arena][type] = renderer;\n}\n\nexport type LogRendererMap = { [type: string]: LogRenderer };\n\nexport function addLogRenderers(arena: string, r: LogRendererMap) {\n    Object.keys(r).forEach(type => addLogRenderer(arena, type, r[type]))\n}\n\n////////////////////////\n\nexport const consentRefApiLogRenderers : LogRendererMap = {\n    // \"CS/getConsentReference\": (a, m) => `Rakendus ${m.sender} kysib nousolekuteenuselt ${receivers(m.receivers)} nqusolekuviidet isiku ${m.message.subjectId} ja eesmargideklaratsiooni ${m.message.purposeDeclarationId} kohta.`\n}\n","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { ProcessState, Message, Payload } from '../process/Base';\nimport { AppState } from '../store';\nimport { selectArena } from './Theatre';\nimport { LogRow, receivers } from './LogRows';\nimport { Modal, Button, ModalFooter } from 'react-bootstrap';\nimport { __ } from '../i18n';\n\ninterface LogProps {\n\tarena: string;\n\towner?: ProcessState<any>;\n\tshowSelf?: boolean;\n\tmaxRows?: number;\n\trows?: Message<any>[];\n\tt?: any;\n\tclassName?: string;\n}\n\n\nclass LogView extends React.Component<LogProps> {\n\n\tstate = {\n\t\tmsg: undefined as (Message<any> | undefined)\n\t}\n\t\n\tclosePopup() {\n\t\tthis.setState({ msg: undefined });\n\t}\n\n\tshowPopup(msg: Message<any>) {\n\t\tthis.setState({ msg });\n\t}\n\n\tfilterFn : (msg: Message<Payload>) => boolean = (msg) => {\n\t\tif (msg.receivers.length === 1 && msg.receivers.includes(msg.sender) && !this.props.showSelf) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.props.owner !== undefined && !(msg.sender === this.props.owner.name || msg.receivers.includes(this.props.owner.name))) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tformatLogLine(msg: Message<Payload>, index: number, owner?: ProcessState<any>) {\n\t\tconst _this = this;\n\t\treturn (<li className=\"log-item\" key={index}>\n\t\t\t{ LogRow(this.props.arena, index, msg, owner, msg => { _this.showPopup(msg) }) }\n\t\t</li>);\n\t\t\t\n\t}\n\n\tpopup() { \n\t\tconst msg = this.state.msg;\n\t\tconst _this = this;\n\t\tconst t = this.props.t || ((a: string) => a);\n\n\t\treturn (\n\t\t\t<Modal show={msg !== undefined} onHide={() => _this.closePopup()} size=\"lg\">\n\t\t\t  <Modal.Body>\n\t\t\t  { msg === undefined ? \"No message?\" : (\n\t\t\t\t<div>\n\t\t\t\t\t<div className=\"row\">\n\t\t\t\t\t\t<h4>Saatja:</h4>\n\t\t\t\t\t\t<p>{ msg!.sender }</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"row\">\n\t\t\t\t\t\t<h4>Saaja:</h4>\n\t\t\t\t\t\t<p>{ receivers(msg!.receivers) }</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"row\">\n\t\t\t\t\t\t<h4>Tüüp:</h4>\n\t\t\t\t\t\t<p>{ msg!.message.type }</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"col\">\n\t\t\t\t\t\t<pre className=\"text-left\">\n\t\t\t\t\t\t\t{ JSON.stringify({ ...msg, type: undefined, statusUpdateChannel: undefined, arena: undefined }, undefined, \"  \") }\n\t\t\t\t\t\t</pre>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t  ) }\n\t\t\t  </Modal.Body>\n\t\t\t  <Modal.Footer>\n\t\t\t\t<Button variant=\"secondary\" onClick={(ev: any) => _this.closePopup()}>{ t('close') }</Button>\n\t\t\t  </Modal.Footer>\n\t\t\t</Modal>\n\t\t\t);\n\t}\n\n\trender() {\n\t\tconst logLines = (this.props.rows!\n\t\t\t.filter(this.filterFn)\n\t\t\t.slice(-(this.props.maxRows || 4)));\n\n\t\tif (logLines.length === 0) {\n\t\t\treturn <>{ __({arena: this.props.arena, process: (this.props.owner || {}) as ProcessState<any> }, \"no-log-lines\") }</>;\n\t\t}\n\n\t\treturn (\n\t\t\t<>\n\t\t\t{ this.popup() }\n\t\t\t<ul className=\"log-view\">\n\t\t\t\t{ logLines.map((line, index) => this.formatLogLine(line, index, this.props.owner)) }\n\t\t\t</ul>\n\t\t\t</>\n\t\t\t);\n\t}\n}\n\nfunction mapStateToProps(state: AppState, ownProps: LogProps) {\n\treturn { rows: selectArena(state, ownProps.arena).log };\n}\n\nexport const MessageLog = connect(mapStateToProps)(LogView);\n\n\nexport class LogButton extends React.PureComponent<LogProps, { show: boolean }> {\n\tstate = { show: false };\n\n\trender() {\n\t\tconst t = this.props.t;\n\t\treturn (<>\n\t\t\t<Modal show={this.state.show} onHide={() => this.setState({ show: false })} size=\"lg\">\n\t\t\t\t<Modal.Header>\n\t\t\t\t\t<Modal.Title>{ __({ arena: this.props.arena, process: this.props.owner! }, \"log\") }: { \n\t\t\t\t\t\tthis.props.owner !== undefined ? __({arena: this.props.arena, process: this.props.owner}, \"title\") : <></> }</Modal.Title>\n\t\t\t\t</Modal.Header>\n\t\t\t\t<Modal.Body>\n\t\t\t\t\t<div className=\"msg-log-popup msg-log\">\n\t\t\t\t\t\t<MessageLog {...this.props}\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</Modal.Body>\n\t\t\t\t<ModalFooter>\n\t\t\t\t\t<Button variant=\"secondary\" onClick={(ev: any) => this.setState({ show: false })}>{ t('close') }</Button>\n\t\t\t\t</ModalFooter>\n\t\t\t</Modal>\n\t\t\t<Button className={this.props.className} onClick={(ev: any) => this.setState({ show: true }) }>{ this.props.children }</Button>\n\t\t</>)\n\t}\n}","import * as React from 'react';\n\nimport { ProcessState, ProcessRenderer, findRenderer, uiMap } from '../process/Base';\nimport { useStore } from 'react-redux';\nimport { launchUI } from '../postMessage';\nimport { __ } from '../i18n';\nimport { LogButton } from './MessageLog';\n\nfunction render<S>({process, arena}: ProcessUIProps<S>): ReturnType<ProcessRenderer<S>> {\n\treturn (findRenderer(process))({process, arena});\n}\n\n// Protsessi-kasti komponent. \n\nexport interface ProcessUIProps<S> {\n\tprocess: ProcessState<S>;\n\tarena: string; // current arena.\n\tchildren?: any;\n\tbutton?: boolean;\n}\n\n\nexport function ProcessUI({process, arena}: ProcessUIProps<any>) {\n\tconst t = (...keys: string[]) => __({arena, process}, ...keys);\n\treturn (\n\t\t<div className=\"col\">\n\t\t\t<div className={`card process style-${ t('stylename') }`} id={`proc-${process.name}`}>\n\t\t\t  <div className=\"card-header\">\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"process-name\"\n\t\t\t\t\t\tonClick={ev => {ev.preventDefault(); alert(JSON.stringify(process, undefined, \"  \"))}}>\n\t\t\t\t\t\t\t{ t(\"title\") }\n\t\t\t\t\t</span>\n\t\t\t\t\t<LogButton arena={arena} owner={process} showSelf={true} maxRows={100} t={t} className=\"btn-log btn-light btn-sm\">log</LogButton>\n\t\t\t  </div>\n\t\t\t  <div className=\"card-body\">\n\t\t\t\t\t<span className=\"process-state\">{ render({process, arena}) }</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n}\n\nexport function UILink({arena, process, children, button }: ProcessUIProps<any>) {\n\tconst store = useStore();\n\tfunction launch() {\n\t\tlaunchUI(arena, process.name, uiMap[process.type], store);\n\t}\n\n\tconst el = button === true ? 'button' : 'div'\n\n\tif (uiMap[process.type] === undefined) {\n\t\treturn <></>;\n\t} else {\n\t\treturn React.createElement(el, {\n\t\t\tclassName: button !==  true ? \"process-uilink\" : \"btn btn-primary\",\n\t\t\tonClick: () => launch()\n\t\t}, children === undefined ? \"\\u2398\" : children);\n\t}\n}\n\n","\ntype NamedObject = { name: string };\n\nexport interface ByNameStore<T extends NamedObject> {\n\tbyName: { [k: string]: T },\n\tallNames: string[];\n}\n\nexport function addByName<T extends NamedObject>(old: ByNameStore<T> = emptyStore(), init: T): ByNameStore<T> {\n\treturn {\n\t\tbyName: { ...old.byName, [init.name]: init },\n\t\tallNames: old.allNames.filter(n => n !== init.name).concat(init.name),\n\t}\n}\n\nexport function reduceByName<T extends NamedObject>(old: ByNameStore<T> = emptyStore(), reducer: (i: T) => T): ByNameStore<T> {\n\treturn {\n\t\t...old,\n\t\tbyName: Object.assign({}, ...old.allNames.map((k) => ({[k]: reducer(old.byName[k])})))\n\t}\n}\n\nexport function emptyStore<T extends NamedObject>(): ByNameStore<T> {\n    return { byName: {}, allNames: [] };\n}\n\nexport function fromArray<T extends NamedObject>(a: T[]): ByNameStore<T> {\n\treturn a.reduce(addByName, emptyStore());\n}","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { Store } from 'redux';\n\nimport { ProcessState, MESSAGE, Message, reduceMessage } from '../process/Base';\n\nimport { ProcessUI } from './Process';\nimport { MessageLog } from './MessageLog';\n\nimport { ByNameStore, addByName, reduceByName, fromArray } from '../byNameStore';\nimport { AppState } from '../store';\nimport { selectArena } from './Theatre';\nimport { useTranslation } from 'react-i18next';\n\n// Arena -- ports protsesse, mis omavahel sõnumeid vahetavad. \n// arenal on nimi?\n\nconst MESSAGE_DELAY = 300; // ms\n\n\ntype ProcessStore = ByNameStore<ProcessState<any>>;\nconst createProcess: (old : ProcessStore, init: ProcessState<any>) => ProcessStore = addByName;\nconst reduceProcesses: (old: ProcessStore, reducer: (p: ProcessState<any>) => ProcessState<any>) => ProcessStore = reduceByName;\n\nexport interface ArenaState {\n  name: string;\n  process: ProcessStore;\n  log: Message<any>[];\n}\n\nexport function createArena(name: string, ps: ProcessState<any>[]): ArenaState {\n  return { name: name, process: fromArray(ps), log: [] };\n}\n\nexport const CREATE_PROCESS = \"Arena/CREATE_PROCESS\"; \n\nexport interface CreateProcess {\n  type: typeof CREATE_PROCESS;\n  arena: string; \n  process: ProcessState<any>;\n}\n\nexport const FLUSH_QUEUE = \"Arena/FLUSH_QUEUE\";\nexport interface FlushQueue {\n  type: typeof FLUSH_QUEUE;\n  arena: string;\n}\n\nexport type ArenaActionType = CreateProcess | FlushQueue | Message<any>;\n\n\nexport function reduceArena(state: ArenaState, action: ArenaActionType): ArenaState {\n  if (action.arena !== state.name) {\n    return state;\n  }\n\n  switch (action.type) {\n    case CREATE_PROCESS:\n      return { ...state, process: createProcess(state.process, action.process) };\n    case FLUSH_QUEUE:\n      return { ...state, process: reduceProcesses(state.process, (p) => ({ ...p, queue: [] })) };\n    case MESSAGE:\n      return { ...state, process: reduceProcesses(state.process, (p) => reduceMessage(p, action)), log: state.log.concat([action])  };\n    default:\n      return state;\n  }\n}\n\nfunction getQueuedForArena(p: ProcessStore): Message<any>[] {\n  return p.allNames.map((n) => p.byName[n].queue).flat(1).filter((d) => d !== undefined);\n}\n\nfunction getQueued(arenas: ByNameStore<ArenaState>): Message<any>[] {\n  return arenas.allNames.map(n => getQueuedForArena(arenas.byName[n].process)).flat(1);\n}\n\nexport function queueListener(store: Store) {\n  let queued = getQueued(store.getState().theatre.arenas);\n\n  if (queued.length === 0) {\n    return;\n  }\n\n  let arenas = Object.keys(Object.assign({}, ...queued.map((m) => ({ [m.arena]: 1 }))))\n\n  arenas.forEach((a) => store.dispatch({ type: FLUSH_QUEUE, arena: a } as FlushQueue ));\n\n  // queued.forEach((m) => store.dispatch(m));\n\n  const delayedSender = (store: Store, queue: Message<any>[]) => {\n    if (queue.length > 0) {\n      store.dispatch({ ...queue.shift()!, now: (Date.now() / 1000) | 0, random: \"\" + Math.random() });\n\n      window.setTimeout(() => { delayedSender(store, queue); }, MESSAGE_DELAY);\n    }\n  };\n  \n  window.setTimeout(() => { delayedSender(store, queued); }, MESSAGE_DELAY);\n}\n\ninterface ArenaProps {\n  arena: ArenaState;\n}\n\nfunction ArenaElement({ arena }: ArenaProps) {\n  const { t } = useTranslation();\n  const processes = arena.process.allNames.map((p) => <ProcessUI process={arena.process.byName[p]} arena={arena.name} key={p} />);\n  return (\n    <div>\n      <div className=\"row\">{ processes }</div>\n      <div className=\"card w-100 mt-4 mb-2\">\n        <div className=\"card-body\">\n          <h5 className=\"card-title\">{t('msg-log.title')}</h5>\n          {arena.log.length === 0 &&\n            <div className=\"d-flex align-items-center\">\n              <div className=\"spinner-grow spinner-grow-sm\" role=\"status\"></div>\n              <p className=\"card-text ml-1\">{t('msg-log.empty')}</p>\n            </div>\n          }\n          <div className=\"msg-log-wrapper\">\n            <samp className=\"msg-log\">\n              <MessageLog arena={arena.name} showSelf={false} maxRows={1000}/>\n              <span className=\"msg-log-anchor\">&nbsp;</span>\n            </samp>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction mapStateToProps(state: AppState, props: ArenaProps) {\n  return { log: selectArena(state, props.arena.name).log };\n}\n\nexport const Arena = connect(mapStateToProps)(ArenaElement);\n\n\n","import * as React from 'react';\nimport { connect } from 'react-redux';\nimport { ProcessState, Payload, message, Message } from '../process/Base';\n\ninterface SendProps<S, M extends Payload> {\n\tarena: string;\n\towner: ProcessState<S>;\n\ttarget?: string | string[];\n\tclassName?: string;\n\tmessage: (values?: any) => M;\n\ttext: string;\n\tmessageToAction: (props: SendProps<S, M>, values?: any) => Message<M>;\n\tonClick?: (ev?: any) => void;\n\ttitle?: string;\n}\n\nfunction fixTarget(owner: ProcessState<any>, target?: string | string[]): string[] {\n\tif (target !== undefined && typeof target === 'string') {\n\t\treturn [target];\n\t}\n\n\tif (target === undefined || target.length === 0) {\n\t\treturn [owner.name];\n\t}\n\n\treturn target;\n}\n\nfunction messageToAction<S, M extends Payload>(props: SendProps<S, M>, values: any) {\n\treturn message(props.arena, props.owner, fixTarget(props.owner, props.target), props.message(values)); \n}\n\nfunction parseOrRaw(s: any): any {\n\tif (typeof s === \"string\" && s.startsWith(\"{\")) {\n\t\treturn JSON.parse(s);\n\t}\n\n\treturn s;\n}\n\nfunction values(f: HTMLFormElement): any {\n\n\tif (f === undefined || f === null) {\n\t\treturn {};\n\t}\n\n\treturn Array.from(f.elements)\n\t\t\t.map((u, i) => f.elements[i] as any as { \n\t\t\t\tname: string;\n\t\t\t\tvalue: any;\n\t\t\t\ttype: string;\n\t\t\t\toptions?: HTMLOptionsCollection;\n\t\t\t\tchecked?: boolean;\n\t\t\t})\n\t\t\t.filter(e => (e.name !== undefined && e.name !== null && e.name !== \"\" && !e.name.startsWith(\"_\")))\n\t\t\t.map(e => {\n\t\t\t\tif (e.type === \"select-multiple\") {\n\t\t\t\t\tlet out: any[] = [];\n\t\t\t\t\tlet i: number;\n\t\t\t\t\tfor (i = 0; i < e.options!.length; i++) {\n\t\t\t\t\t\tif (e.options![i].selected) {\n\t\t\t\t\t\t\tout.push(parseOrRaw(e.options![i].value));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn { [e.name]: out };\n\t\t\t\t}\n\n\t\t\t\tif (e.type === \"checkbox\") {\n\t\t\t\t\tlet values: (string | undefined)[] = e.value.split(\"|\", 2);\n\t\t\t\t\tif (values.length === 1) {\n\t\t\t\t\t\tvalues.push(undefined);\n\t\t\t\t\t}\n\t\t\t\t\treturn { [e.name]: parseOrRaw(values[e.checked ? 0 : 1]) }\n\t\t\t\t}\n\t\t\t\treturn { [e.name]: parseOrRaw(e.value) }\n\t\t\t})\n\t\t\t.reduce((o, c) => ({ ...o, ...c }), {});\n}\n\nclass Send<S, M extends Payload> extends React.Component<SendProps<S, M>> {\n\n\thandleClick(ev: any) {\n\t\tev.preventDefault();\n\t\tthis.props.messageToAction(this.props, values(ev.currentTarget.form));\n\t\tif(this.props.onClick) this.props.onClick(ev);\n\t};\n\n\trender() {\n\t\treturn <button \n\t\t\tclassName={ this.props.className === undefined ? \"btn btn-primary\" : this.props.className } \n\t\t\tonClick={(ev) => this.handleClick(ev)}\n\t\t\ttitle={this.props.title}\n\t\t>{this.props.text}</button>\n\t}\n}\n\nexport const SimpleSend = connect(null, { messageToAction })(Send);\n\n","import { ProcessImplName, ViewName, ProcessState, Payload, GenericMessageHandler, Message, addHandlerClass, ProcessAndArena, addRenderer } from './Base';\nimport * as React from 'react';\nimport { SimpleSend } from '../components/SendButton';\nimport { MessageLog } from '../components/MessageLog';\n\nconst Counter : ProcessImplName = \"Counter\";\n\nconst CounterDefaultView : ViewName = \"_\";\n\n// \"rakenduse olek\"\nexport interface CounterState extends ProcessState<number> {\n\ttype: typeof Counter;\n\tview: typeof CounterDefaultView;\n}\n\n// \"bootloader\", tekitab rakenduse algoleku\nexport function createCounter(name: string) {\n\treturn {\n\t\tname: name,\n\t\ttype: Counter,\n\t\tview: CounterDefaultView,\n\t\tmem: 0,\n\t} as CounterState;\n}\n\nclass IncrementMessageHandler extends GenericMessageHandler<number, CounterState, Payload, IncrementMessageHandler> {\n\tname = \"Counter/INC\";\n\tupdateMem(mem: number, action: Message<Payload>) { return mem + 1; }\n}\n\n\nclass DecrementMessageHandler extends GenericMessageHandler<number, CounterState, Payload, DecrementMessageHandler> {\n\tname = \"Counter/DEC\";\n\tupdateMem(mem: number, action: Message<Payload>) { return mem - 1; }\n}\n\nconst incrementMessage = addHandlerClass(Counter, IncrementMessageHandler);\nconst decrementMessage = addHandlerClass(Counter, DecrementMessageHandler);\n\n\ninterface DefaultViewProps extends ProcessAndArena<number> {\n\tprocess: CounterState;\n\tarena: string;\n}\n\nconst counterRenderer : React.FC<DefaultViewProps> = ({process, arena}) => {\n\treturn (\n\t<div>\n\t\t<span className=\"process-state\">{ process.mem }</span>\n\t\t<span className=\"process-state\">\n\t\t\t<SimpleSend arena={arena} owner={process} text=\"+\" message={incrementMessage()}/>\n\t\t\t<SimpleSend arena={arena} owner={process} text=\"-\" message={decrementMessage()}/>\n\t\t</span>\n\t\t<span className=\"process-state\">\n\t\t\t<MessageLog arena={arena} owner={process} showSelf={true} maxRows={4}/>\n\t\t</span>\n\t</div>\n\t);\n};\n\n\naddRenderer(Counter, CounterDefaultView, counterRenderer);\n","import * as React from 'react';\n\ninterface PopupProps {\n    text: any;\n    open?: boolean; // initial state\n}\n\nexport class Popup extends React.Component<PopupProps, { open: boolean }> {\n    state = { open: false };\n\n    render() {\n        return (\n            <div>\n                <div className={ this.state.open ? \"popup-visible\" : \"popup-hidden\" }>\n                    <div className=\"popup-content\">\n                        <div className=\"popup-close\" onClick={() => this.setState({open: false})}></div>\n                        {this.props.children}\n                    </div>\n                </div>\n                <button className=\"btn btn-primary\" onClick={() => this.setState({open: true})}>{this.props.text}</button>\n            </div>\n        );\n    }\n}","import * as React from \"react\";\n\ninterface Props {}\n\ninterface State {\n  view: string;\n  loading: boolean;\n}\n\nconst LOGIN = \"login\";\nconst SELECT_SERVICE = \"selectService\";\nconst SERVICE_V1 = \"serviceV1\";\n\nconst Header = () => (\n  <div className=\"app-header\">\n    <div className=\"app-user-icon\">\n      <img alt=\"user icon\" src={require('./../static/assets/images/user-icon.svg')} />\n    </div>\n    <p className=\"app-user\">TERE MARI-LIIS MÄNNIK</p>\n  </div>\n);\n\nclass ClientView extends React.PureComponent<Props, State> {\n\n  state = {\n    view: LOGIN,\n    loading: false\n  };\n\n  changeView = (view: string) => {\n    this.setState({ loading: true });\n    setTimeout(() => {\n      this.setState({loading: false});\n      this.setState({view: view});\n    }, 1000);\n  };\n\n  render() {\n    switch (this.state.loading) {\n      case true:\n      return (\n        <div className=\"d-flex align-items-center\">\n          <strong>Loading...</strong>\n          <div className=\"spinner-border ml-auto\" role=\"status\" aria-hidden=\"true\"></div>\n        </div>\n      );\n      default:\n        switch (this.state.view) {\n          case LOGIN:\n          return (\n            <div>\n              <h4>Tere! Teenuse kasutamiseks logi palun sisse.</h4>\n              <button className=\"btn btn-light border\" onClick={() => this.changeView(SELECT_SERVICE)}>Logi sisse kasutajana Mari-Liis Männik 47302200234</button>\n              <p className=\"mt-4\">\n                <img alt=\"illustration\" src={require('./../static/assets/images/login.svg')} width=\"280\" />\n              </p>\n            </div>\n          );\n          case SELECT_SERVICE:\n          return (\n            <div>\n              <Header />\n              <h4>Vali teenus mida soovid kasutada:</h4>\n              <button className=\"btn btn-dark\" onClick={() => this.changeView(SERVICE_V1)}>Vaktsineerimiste meeldetuletused</button>\n            </div>\n          );\n          case SERVICE_V1:\n          return (\n            <div>\n              <Header />\n              <h4>Teenuse tekst TODO</h4>\n              <p className=\"text-left\">\n                <small>Enne nõusoleku andmist veendu, et oled tutvunud meie privaatsuspoliitika ja kasutustingimustega, mis on leiavad <a href=\"JavaScript:void(0);\">siin</a>. Nõusoleku andmiseks suuname Sind e-Tervise nõusolekute keskkonda, mida haldab Tervise- ja Heaolu Infosüsteemide Keskus.</small>\n              </p>\n              <button className=\"btn btn-lg btn-primary\">Annan nõusoleku</button>\n            </div>\n          );\n          default:\n          return(null)\n        }\n    }\n  }\n}\n\nexport default ClientView;","import * as React from 'react';\nimport { ProcessAndArena, ProcessImplName, ViewName, ProcessState, GenericMessageHandler, Payload, Message, message, addHandlerClass, addRenderer, addUi } from './Base';\nimport { SimpleSend } from '../components/SendButton';\nimport { MessageLog } from '../components/MessageLog';\nimport { Popup } from '../components/Popup';\nimport { Modal, Button } from 'react-bootstrap';\nimport { useTranslation } from 'react-i18next';\nimport ClientView from './../components/Client';\n\nconst TokenNode : ProcessImplName = \"TokenNode\";\n\nconst WithToken : ViewName = \"with\";\nconst WithoutToken : ViewName = \"without\";\n\ninterface NodeState {\n  token?: string; // token I have or undefined\n  next: string; // next station.\n}\n\ninterface NodePS extends ProcessState<NodeState> {\n  type: typeof TokenNode;\n  view: typeof WithToken | typeof WithoutToken;\n  title: string;\n}\n\nexport function createTokenNode(title: string, name: string, next: string, token?: string): NodePS {\n  return {\n    title: title,\n    name: name,\n    type: TokenNode,\n    view: token === undefined ? WithoutToken : WithToken,\n    mem: {\n      token: token,\n      next: next\n    },\n    queue: [],\n  };\n}\n\nclass InitPassHandler extends GenericMessageHandler<NodeState, NodePS, Payload, InitPassHandler> {\n  name = \"TokenNode/InitPass\";\n  handle(node: NodePS, action: Message<Payload>) {\n    if (node.view !== WithToken) {\n      console.error(`Invalid message, order to pass while I have no token? ${JSON.stringify(node)}`);\n      return node;\n    }\n\n    \n    return {\n      ...node,\n      queue: node.queue.concat(message(action.arena, node, [node.mem.next], tokenMessage({token: node.mem.token})())),\n      mem: { ...node.mem, token: undefined },\n      view: WithoutToken,\n    };\n  }\n}\n\nconst initPassMessage = addHandlerClass(TokenNode, InitPassHandler);\n\n\n// selle sõnumiga saadetakse reaalselt tokeneid.\ninterface TokenMessage extends Payload {\n  token: string;\n}\n\nclass PostTokenHandler extends GenericMessageHandler<NodeState, NodePS, TokenMessage, PostTokenHandler> {\n  name = \"TokenNode/PostToken\";\n  // sissetulev token\n  handle(node: NodePS, action: Message<TokenMessage>) {\n    if (node.view === WithToken) {\n      console.log(`${action.sender} sent token '${action.message.token}' to ${node.name}. We already have a token (${node.mem.token}). Will send the token back`);\n      // send it back.\n      return {\n        ...node,\n        queue: node.queue.concat(message(action.arena, node, [action.sender], action.message)),\n      };\n    } else {\n      // tokenit polnud, jätame meelde.\n      return {\n        ...node,\n        mem: { ...node.mem, token: action.message.token },\n        view: WithToken,\n      };\n\n    }\n  }\n}\n\nconst tokenMessage = addHandlerClass<TokenMessage, PostTokenHandler>(TokenNode, PostTokenHandler);\n\n\ninterface TargetPayload extends Payload {\n  target: string;\n}\n\nclass UpdateTargetHandler extends GenericMessageHandler<NodeState, NodePS, Payload, InitPassHandler> {\n  name = \"TokenNode/UpdateTarget\";\n  updateMem(mem: NodeState, action: Message<TargetPayload>) {\n    return { ...mem, next: action.message.target };\n  }\n}\n\nconst updateNextMessage = addHandlerClass(TokenNode, UpdateTargetHandler);\n\n\n////\n\ninterface NodeViewProps extends ProcessAndArena<NodeState> {\n  process: NodePS,\n}\n\nconst SetTargetPopup : React.FC<NodeViewProps> = ({process, arena}) => {\n\n  const { t } = useTranslation();\n  const [show, setShow] = React.useState(false);\n  const handleClose = () => setShow(false);\n  const handleShow = () => setShow(true);\n\n  switch(process.name) {\n    case \"a\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Teenusedeklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"baseName\">Andmekogu nimi:</label>\n                    <input name=\"baseName\" type=\"text\" className=\"form-control\" id=\"baseName\" value=\"test\" readOnly />\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"xtee\">Andmekogu X-tee:</label>\n                    <input name=\"xtee\" type=\"text\" className=\"form-control\" id=\"xtee\" value=\"123\" readOnly />\n                    <small id=\"xteeHelp\" className=\"form-text text-muted\">(alamsüsteemi) identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdName\">Teenusedeklaratsiooni nimi:</label>\n                    <input name=\"sdName\" type=\"text\" className=\"form-control\" id=\"sdName\" />\n                    <small id=\"sdNameHelp\" className=\"form-text text-muted\">Teenusedeklaratsiooni identifikaator inimloetaval kujul. Soovitatavalt teenuse kood/nimi ja vajadusel alamteenuse identifikaator.</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdIdentifier\">Teenusedeklaratsiooni identifikaator:</label>\n                    <input name=\"sdIdentifier\" type=\"text\" className=\"form-control\" id=\"sdIdentifier\" />\n                    <small id=\"sdIdentifierHelp\" className=\"form-text text-muted\">Andmekogu poolt määratud teenusedeklaratsiooni masinloetav identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdDescription\">Teenuse andmekoosseisu kirjeldus:</label>\n                    <input name=\"sdDescription\" type=\"text\" className=\"form-control\" id=\"sdDescription\" />\n                    <small id=\"sdDescriptionHelp\" className=\"form-text text-muted\">Teenuse poolt tagastatava andmekoosseisu inimloetav kirjeldus. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <div className=\"form-check\">\n                      <input name=\"signature\" className=\"form-check-input\" type=\"checkbox\" id=\"signature\" />\n                      <label className=\"form-check-label\" htmlFor=\"signature\">Vajab digiallkirja?</label>\n                      <small id=\"signatureHelp\" className=\"form-text text-muted\">Märgista see väli, kui andmesubjekt peab selle teenuse andmetele nõusoleku andmisel nõusoleku digitaalselt allkirjastama.</small>\n                    </div>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text=\"Update\" message={updateNextMessage()}/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('register')}\n      </Button>\n      </>\n    )\n    case \"b\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Eesmärgideklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"applicationName\">Klientrakenduse nimi:</label>\n                    <input name=\"applicationName\" type=\"text\" className=\"form-control\" id=\"applicationName\" value=\"test\" readOnly />\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"applicationXtee\">Klientrakenduse X-tee:</label>\n                    <input name=\"applicationXtee\" type=\"text\" className=\"form-control\" id=\"applicationXtee\" value=\"123\" readOnly />\n                    <small id=\"applicationXteeHelp\" className=\"form-text text-muted\">(alamsüsteemi) identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dIdentifier\">Deklaratsiooni identifikaator:</label>\n                    <input name=\"dIdentifier\" type=\"text\" className=\"form-control\" id=\"dIdentifier\" />\n                    <small id=\"dIdentifierHelp\" className=\"form-text text-muted\">Klientrakenduse poolt määratud eesmärgideklaratsiooni identifikaator</small>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"dataUsage\">Andmete kasutamise eesmärk:</label>\n                    <input name=\"dataUsage\" type=\"text\" className=\"form-control\" id=\"dataUsage\" />\n                    <small id=\"dataUsageHelp\" className=\"form-text text-muted\">Andmesubjekti andmete töötlemise eesmärk. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"services\">Kasutatavad teenused:</label>\n                    <select name=\"services\" className=\"custom-select\" multiple defaultValue={['1']} id=\"services\">\n                      <option value=\"1\">One</option>\n                      <option value=\"2\">Two</option>\n                      <option value=\"3\">Three</option>\n                    </select>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text=\"Update\" message={updateNextMessage()}/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('register')}\n      </Button>\n      </>\n    )\n    case \"c\":\n    return (\n      <>\n      <Modal show={show} onHide={handleClose} size=\"lg\" bsPrefix=\"client-app modal\">\n        <Modal.Header>\n          <Modal.Title>HealthStartup</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <ClientView />\n        </Modal.Body>\n        <Modal.Footer>\n          <Button variant=\"outline-dark\" onClick={handleClose}>Close</Button>\n        </Modal.Footer>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        {t('continue')}\n      </Button>\n      </>\n    )\n    default:\n    return (\n      <Popup text=\"Set target\">\n        <form>\n          <input name=\"target\" size={20}/>\n          <SimpleSend arena={arena} owner={process} text=\"Update target\" message={updateNextMessage()}/>\n        </form>\n      </Popup>\n    )\n  }\n};\n\nconst tokenlessRenderer : React.FC<NodeViewProps> = ({process, arena}) => {\n  return (\n    <div>\n      {/*\n      <span className=\"process-state\">next: {process.mem.next}</span>\n      */}\n      <SetTargetPopup arena={arena} process={process}/>\n      <span className=\"process-state\">\n        <MessageLog arena={arena} owner={process} showSelf={true} maxRows={2}/>\n      </span>\n    </div>\n  )\n};\n\nconst tokenfulRenderer : React.FC<NodeViewProps> = ({process, arena}) => {\n  return (<div>\n    <span className=\"process-state\">{process.mem.token}</span>\n    <span className=\"process-state\">next: {process.mem.next}</span>\n    <span className=\"process-state d-none\"><SimpleSend arena={arena} owner={process} text=\"Pass the token\" message={initPassMessage()}/></span>\n    <SetTargetPopup arena={arena} process={process}/>\n    <span className=\"process-state\">\n      <MessageLog arena={arena} owner={process} showSelf={true} maxRows={4}/>\n    </span>\n  </div>);\n}\n\naddRenderer(TokenNode, WithToken, tokenfulRenderer);\naddRenderer(TokenNode, WithoutToken, tokenlessRenderer);\n\naddUi(TokenNode, \"/ui/dummy\");","import { ProcessImplName, ViewName, ProcessState } from \"../Base\";\nimport { PurposeDeclaration } from \"../consentService/types\";\n\n\nexport const ClientIS : ProcessImplName = \"ClientIS\";\nexport const ClientDefaultView : ViewName = \"loginView\";\n\nexport type PurposeDeclarationTemplate = Partial<PurposeDeclaration> & { purposeDeclarationId: string; }\n\n// the Client \"implements\" requests as defined in config\nexport interface ClientConfig {\n    // purpose declaration\n    purposeDeclarationId: string;\n    services: { // services it needs\n        serviceAddress: string;\n        serviceName: string;\n    }[];\n}\nexport interface ClientState {\n    ui: {\n        user?: string; // authenticated data subject id or null\n        service?: string;\n        response?: {\n            // used to match async messag\n            requestReferenceId: string;\n            purposeDeclarationId: string;\n            serviceAddress: string;\n            serviceName: string;\n            data: any;\n        }[];\n    };\n\n    db: {\n        consentServiceId: string; // should be per purpose\n        consentRefByUser: { [key: string]: { [key: string]: string | null; } }; // userid -> purposedeclarationid -> consentref\n        purpose: { // purposedeclarationid -> servicedesc[]\n            [key: string]: { \n                serviceAddress: string; // the actual communication address\n                serviceId: string;      // actual \"service\"\n            }[];\n         } \n    };\n\n    declTemplate?: PurposeDeclarationTemplate[];\n\n    config: ClientConfig[];\n}\n\nexport interface ClientPS extends ProcessState<ClientState> {\n    type: typeof ClientIS;\n    view: typeof ClientDefaultView;\n}\n","import { ViewName, ProcessImplName, ProcessState } from '../Base';\n\nexport const ConsentService : ProcessImplName = \"ConsentService\";\nexport const ConsentServiceDefaultView : ViewName = \"loginView\";\n\n\nexport interface ConsentServicePS extends ProcessState<ConsentServiceState> {\n    type: typeof ConsentService;\n    view: typeof ConsentServiceDefaultView;\n}\n\nexport interface ServiceDeclaration {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n    name: string;\n    description: string;\n    technicalDescription: string;\n    consentMaxDurationSeconds: number; // integer\n    needSignature: boolean;\n    validUntil?: number; // timestamp as seconds from unix epoch?\n    maxCacheSeconds?: number;\n}\n\nexport interface ServiceDeclarationRef {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n}\n\nexport interface PurposeDeclaration {\n    clientId: string;\n    purposeDeclarationId: string;\n    name: string;\n    description: string;\n    services: ServiceDeclarationRef[];\n    validUntil?: number; // seconds from unix epoch\n    options: any;\n}\n\nexport interface Consent {\n    dataSubject: string;\n    clientId: string;\n    purposeDeclarationId: string;\n    validFrom: number;\n    validUntil: number;\n    revoked: boolean;\n    consentReference: string; // used only in protocol\n}\n\nexport interface UsageRecord {\n    usageTime: number; // seconds from unix epoch\n    serviceProviderId: string;\n    requestReference: string;\n    consentReference?: string;\n    subjectId: string;\n    clientId: string;\n    serviceDeclarationIds: string[];\n    result: \"OK\" | \"ACCESS_DENIED\" | \"OTHER_FAIL\";\n}\n\nexport interface PurposeDeclarationRef {\n    clientId: string;\n    purposeDeclarationId: string;\n}\n\nexport interface ActivePurposeDeclarationRef extends PurposeDeclarationRef {\n    callbackURL?: string;\n}\n\nexport interface ConsentServiceState {\n    ui: {\n        user?: string;\n        activePurposeDeclaration: {\n            [userid: string]: ActivePurposeDeclarationRef;\n        };\n    }\n\n    db: {\n        serviceDeclarations: ServiceDeclaration[];\n        purposeDeclarations: PurposeDeclaration[];\n        consents: Consent[];\n        usageLog: UsageRecord[];\n    }\n}\n\nexport function findFrom<T extends U, U extends any>(items: T[], example: U): T | undefined {\n    return items.find(\n        i => { \n            return Object.keys(example).filter(\n                k => (i as T)[k] !== (example as U)[k]\n            ).length === 0\n        }\n    );\n}\n\n\n","import { createHash } from \"crypto\";\nimport React from \"react\";\n\n\nexport function hash(input: string): string {\n    return createHash(\"sha256\").update(input).digest(\"hex\").substring(0, 6);\n}\n\n// converts transport address to organization id\nexport function address2org(address: string): string {\n    let m = address.match(\"^([^/]+/[^/]+/[^/]+)(/.*)?$\");\n    if (m === null) {\n        // not an X-Road member id or more specific address?\n        return address;\n    }\n    \n    return m[1];\n}\n\nexport function renderText(t: string) {\n    type OutElement = { text: string; indent: number; children: OutElement[] };\n    let stack: OutElement[] = [];\n\n    function last(a: OutElement[]): OutElement {\n        return a[a.length - 1];\n    }\n\n    stack.push({ text: \"\", indent: -1, children: [] });\n\n    t.split(\"\\n\").forEach(l => {\n        let pref = l.match(\"^((  )+\\\\* )(.*)$\");\n        if (pref === null) {\n            pref = [\"\", \"\", \"\", l];\n        }\n\n        let prefix = pref[1];\n        let text = pref[3];\n\n        while (prefix.length <= last(stack).indent) {\n            // the same level -> back up, so it will be actually a new level?\n            stack.pop();\n        }\n\n        if (prefix.length > last(stack).indent) {\n            // new level\n            last(stack).children.push({ text: text, indent: prefix.length, children: [] })\n            stack.push(last(last(stack).children));\n        }\n    });\n\n    function ul(children: OutElement[]) {\n        if (children.length === 0) {\n            return <></>;\n        }\n\n        return (\n            <ul className=\"desc-markup\">{ \n                children.map(c => <li className=\"desc-markup\">{ c.text }{ ul(c.children) }</li>)\n            }</ul>\n        );\n    }\n\n    return stack[0].children.map(c => <><p className=\"desc-markup\">{ c.text }</p>{ ul(c.children) }</>);\n}","import { ServiceDeclaration, ConsentServiceState, findFrom, PurposeDeclaration, ConsentService, ConsentServicePS } from './types'\nimport { GenericMessageHandler, Message, addHandlerClass, updateDb } from '../Base';\nimport { address2org } from '../../util';\n\n// {Service,Purpose}Declaration API messages and their processing\n\ninterface ServiceDeclarationMessage extends ServiceDeclaration {\n    type: typeof AddServiceDeclarationMessage.name;\n}\n\nclass AddServiceDeclarationMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ServiceDeclarationMessage, AddServiceDeclarationMessage> {\n    name = \"CS/addServiceDeclaration\"; \n\n    addServiceDeclaration(cs: ConsentServicePS, sd: ServiceDeclaration): ConsentServicePS {\n        return updateDb(cs, { serviceDeclarations: cs.mem.db.serviceDeclarations.concat(sd) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<ServiceDeclarationMessage>) {\n        console.log(`addServiceDeclaration: ${JSON.stringify(msg)}`);\n\n        let decl = msg.message;\n\n        if (findFrom(\n            cs.mem.db.serviceDeclarations,\n            { serviceProviderId: decl.serviceProviderId, serviceDeclarationId: decl.serviceDeclarationId }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"duplicate_declaration\");\n        }\n\n        if (decl.serviceProviderId !== address2org(msg.sender)) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", {\n                 msg: \"serviceProvcderId in declaration and message do not match\"\n            });\n        }\n\n        if (decl.serviceDeclarationId === undefined || !decl.serviceDeclarationId.match(\"^[!-~]+$\")) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid service declaration id\"});\n        }\n\n        return this.withOkResponse(this.addServiceDeclaration(cs, { ...msg.message, type: undefined } as ServiceDeclaration), msg);\n    }\n}\n\nexport const addServiceDeclaration = addHandlerClass(ConsentService, AddServiceDeclarationMessage);\n\ninterface PurposeDeclarationMessage extends PurposeDeclaration {\n    type: typeof AddPurposeDeclarationMessage.name;\n}\n\nclass AddPurposeDeclarationMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, PurposeDeclarationMessage, AddPurposeDeclarationMessage> {\n    name = \"CS/addPurposeDeclaration\"; \n\n    addPurposeDeclaration(cs: ConsentServicePS, pd: PurposeDeclaration): ConsentServicePS {\n        return updateDb(cs, { purposeDeclarations: cs.mem.db.purposeDeclarations.concat(pd) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<PurposeDeclarationMessage>) {\n        console.log(`addPurposeDeclaration: ${JSON.stringify(msg)}`);\n\n        let decl = msg.message;\n\n        if (findFrom(\n            cs.mem.db.purposeDeclarations,\n            { clientId: decl.clientId, purposeDeclarationId: decl.purposeDeclarationId }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"duplicate_declaration\");\n        }\n\n        if (decl.clientId !== address2org(msg.sender)) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"clientId in declaration and message do not match\"});\n        }\n\n        if (decl.purposeDeclarationId === undefined || !decl.purposeDeclarationId.match(\"^[!-~]+$\")) {\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid purpose declaration id\"});\n        }\n\n        if (decl.services.length === 0 || decl.services.find(sdRef => {\n            // true if sdRerf does not match with any of existing servicedeclarations\n            return findFrom(cs.mem.db.serviceDeclarations, sdRef) === undefined;\n        }) !== undefined) {\n\n            return this.withErrorResponse(cs, msg, \"invalid_request\", { msg: \"Invalid or missing SD reference(s)\"});\n        }\n\n        return this.withOkResponse(this.addPurposeDeclaration(cs, { ...msg.message, type: undefined } as PurposeDeclaration), msg);\n    }\n}\n\nexport const addPurposeDeclaration = addHandlerClass(ConsentService, AddPurposeDeclarationMessage);\n","import { Payload, GenericMessageHandler, Message, addHandlerClass, message, updateDb } from '../Base';\nimport { ConsentServiceState, ConsentServicePS, ConsentService, findFrom, Consent, PurposeDeclarationRef, ActivePurposeDeclarationRef } from './types';\nimport { fetchConsentReference } from '../client/messages';\n\n// messages that the ConsentService UI can send \n\nexport interface LoginMessage extends Payload {\n    type: typeof LoginMessageHandler.name;\n    user?: string;\n}\n\nclass LoginMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, LoginMessage, LoginMessageHandler> {\n    name = \"CS/UI/login\";\n\n    handle(cs: ConsentServicePS, action: Message<LoginMessage>): ConsentServicePS {\n        console.log(\"login message: \", action); \n        return { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, user: action.message.user } } };\n    }\n}\n\nexport const loginMessage = addHandlerClass<LoginMessage, LoginMessageHandler>(ConsentService, LoginMessageHandler);\n\ninterface ConsentMessage extends Consent, Payload {\n    type: typeof GiveConsentMessageHandler.name;\n}\n\nclass GiveConsentMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ConsentMessage, GiveConsentMessageHandler> {\n    name: string = \"CS/UI/giveConsent\";\n\n    addConsent(cs: ConsentServicePS, con: Consent): ConsentServicePS {\n        return updateDb<typeof cs.mem.db, ConsentServiceState>(cs, { consents: cs.mem.db.consents.concat(con) });\n    }\n\n    handle(cs: ConsentServicePS, msg: Message<ConsentMessage>): ConsentServicePS {\n        let newConsent = msg.message;\n        if (findFrom(cs.mem.db.purposeDeclarations, { \n            clientId: newConsent.clientId,\n             purposeDeclarationId: newConsent.purposeDeclarationId\n        }) === undefined) {\n            console.error(\"Attempt to add consent for unknown purpose declaration: \", newConsent);\n            return cs;\n        }\n\n        if (findFrom(cs.mem.db.consents, {\n            clientId: msg.message.clientId,\n            purposeDeclarationId: msg.message.purposeDeclarationId,\n            dataSubject: msg.message.dataSubject,\n            revoked: false\n        }) !== undefined) {\n            console.error(\"Attempt to add duplicate consent?\");\n            return cs;\n        }\n\n        console.log(\"Adding consent: \", msg.message);\n\n        let updatedCS = this.addConsent(cs, { ...msg.message, type: undefined } as Consent);\n\n        let activeUser = cs.mem.ui.user;\n        if (activeUser === undefined || cs.mem.ui.activePurposeDeclaration[activeUser] === undefined) {\n            // no user, no active pd --> no callback\n            return updatedCS;\n        }\n\n        let decl = cs.mem.ui.activePurposeDeclaration[activeUser];\n\n        // forget that we had pd selected.\n        let updatedCS2 = setActivePD(updatedCS, activeUser, undefined);\n\n        if (decl.clientId !== msg.message.clientId || decl.purposeDeclarationId !== msg.message.purposeDeclarationId \n                || decl.callbackURL === undefined) {\n            return updatedCS2;\n        }\n\n        // if the client application asked for callback, we send it a message about the \n        // consent being signed. reusing UI message from client implementation.\n        return this.send(updatedCS2, message(msg.arena, updatedCS, [decl.callbackURL],\n            fetchConsentReference({ purposeDeclarationId: decl.purposeDeclarationId })()\n        ));\n\n    }\n}\n\nexport const giveConsentMessage = addHandlerClass<ConsentMessage, GiveConsentMessageHandler>(ConsentService, GiveConsentMessageHandler);\n\n\ninterface RevokeConsentMessage extends Payload {\n    type: typeof RevokeConsentMessageHandler.name;\n    consentReference: string;\n    revokeAt: number;\n}\n\nclass RevokeConsentMessageHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, RevokeConsentMessage, RevokeConsentMessageHandler> {\n    name: string = \"CS/UI/revokeConsent\";\n\n    revokeIfReferenceEquals(con: Consent, ref: RevokeConsentMessage) : Consent {\n        if (con.consentReference === ref.consentReference) {\n            return { ...con, revoked: true, validUntil: ref.revokeAt};\n        } \n\n        return con;\n    }\n\n    revokeConsent(cs: ConsentServicePS, ref: RevokeConsentMessage): ConsentServicePS {\n        return updateDb(cs, { consents: cs.mem.db.consents.map(a => this.revokeIfReferenceEquals(a, ref))});\n    }\n    \n    handle(cs: ConsentServicePS, msg: Message<RevokeConsentMessage>): ConsentServicePS {\n        return this.revokeConsent(cs, msg.message);\n    }\n}\n\nexport const revokeConsentMessage = addHandlerClass<RevokeConsentMessage, RevokeConsentMessageHandler>(ConsentService, RevokeConsentMessageHandler);\n\nfunction updateAPDforUser<R extends { [ user: string]: ActivePurposeDeclarationRef }>(refs: R, user: string, ref?: ActivePurposeDeclarationRef): R {\n    return { ...refs, [user]: ref };\n}\n\nexport function setActivePD(cs: ConsentServicePS, user: string, ref?: ActivePurposeDeclarationRef): ConsentServicePS {\n    return { ...cs, mem: { ...cs.mem, ui: { \n        ...cs.mem.ui,\n         activePurposeDeclaration: updateAPDforUser(cs.mem.ui.activePurposeDeclaration, user, ref)\n    }}}\n}\n\ninterface ActivatePurposeDeclaration extends Payload, PurposeDeclarationRef {\n    type: typeof ActivatePurposeDeclarationHandler.name;\n    user?: string;\n}\n\nclass ActivatePurposeDeclarationHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ActivatePurposeDeclaration, ActivatePurposeDeclarationHandler> {\n    name = \"CS/UI/activatePurposeDeclaration\";\n\n    handle(cs: ConsentServicePS, action: Message<ActivatePurposeDeclaration>): ConsentServicePS {\n        return setActivePD(\n            cs,\n            action.message.user === undefined ? cs.mem.ui.user! : action.message.user,\n            {\n                clientId: action.message.clientId,\n                purposeDeclarationId: action.message.purposeDeclarationId,\n            }\n        );\n    }\n}\n\nexport const activatePurposeDeclarationMessage = addHandlerClass<ActivatePurposeDeclaration, ActivatePurposeDeclarationHandler>(ConsentService, ActivatePurposeDeclarationHandler);\n","import { GenericMessageHandler, Message, Payload, addHandlerClass, updateDb } from \"../Base\";\nimport { ConsentServiceState, ConsentServicePS, findFrom, ConsentService, Consent } from \"./types\";\nimport { setActivePD } from \"./ui\";\n\ninterface ConsentReferenceRequest extends Payload {\n    type: typeof GetConsentReferenceMessage.name;\n    clientId: string;\n    purposeDeclarationId: string;\n    subjectId: string;\n    callbackURL?: string;\n    code?: string;\n}\n\nexport const  ConsentReferenceResponseTypeName = \"CS/getConsentReference/response\";\nexport interface ConsentReferenceResponse extends Payload {\n    type: typeof ConsentReferenceResponseTypeName;\n    clientId: string; \n    purposeDeclarationId: string;\n    consentReference: string;\n}\n\nexport function fixRevoked(now: number): ((c: Consent) => Consent) {\n    return (c => ((!c.revoked && c.validUntil < now) ? { ...c, revoked: true } : c));\n}\n\nclass GetConsentReferenceMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ConsentReferenceRequest, GetConsentReferenceMessage> {\n    name: string = \"CS/getConsentReference\";\n\n    handle (cs: ConsentServicePS, msg: Message<ConsentReferenceRequest>): ConsentServicePS {\n\n        let req = msg.message;\n\n        // mark expired consents as revoked, as optimization\n        let _cs : ConsentServicePS = updateDb<typeof cs.mem.db, ConsentServiceState>(\n            cs, { consents: cs.mem.db.consents.map(fixRevoked(msg.now!)) }\n        );\n\n        const consent = findFrom(\n            _cs.mem.db.consents,\n            {\n                purposeDeclarationId: req.purposeDeclarationId,\n                dataSubject: req.subjectId,\n                revoked: false,\n            }\n        );\n\n        if (consent === undefined) {\n            return this.withErrorResponse(\n                setActivePD(_cs, req.subjectId, {\n                    clientId: req.clientId,\n                    purposeDeclarationId: req.purposeDeclarationId,\n                    callbackURL: req.callbackURL\n                }),\n                msg,\n                \"consent_not_found\"\n            );\n        }\n\n        return this.withResponse<ConsentReferenceResponse>(\n            _cs,\n            msg,\n            {\n                type: ConsentReferenceResponseTypeName,\n                clientId: msg.message.clientId,\n                purposeDeclarationId: msg.message.purposeDeclarationId,\n                consentReference: consent.consentReference\n            })\n    }\n}\n\nexport const getConsentReference = addHandlerClass<ConsentReferenceRequest, GetConsentReferenceMessage>(ConsentService, GetConsentReferenceMessage);\n\n","import { ProcessImplName, ViewName, ProcessState, Payload } from \"../Base\";\nimport { ServiceDeclaration } from \"../consentService/types\";\n\n\nexport const ServiceProviderIS : ProcessImplName = \"ServiceProviderIS\";\nexport const ServiceProviderDefaultView : ViewName = \"defaultView\";\n\nexport interface ServiceProviderPS extends ProcessState<ServiceProviderState> {\n    type: typeof ServiceProviderIS;\n    view: typeof ServiceProviderDefaultView;\n}\n\n\nexport interface SecretRecord {\n    key: string;\n    type: string;\n    subject: string;\n    data: any;\n} \n\nexport interface ServiceConfig {\n    consentService: string;\n    serviceName: string;\n    requiredServiceDeclarationIds: string[];\n    returnedDatatypes: string[];\n}\n\nexport const requestTypeName = \"SP/request\";\n\nexport interface ServiceRequest extends Payload {\n    type: typeof requestTypeName;\n    clientId: string;\n    serviceName: string;\n    subjectId: string;\n    consentReference?: string;\n    requestReference: string;\n}\n\nexport const responseTypeName = \"SP/request/response\";\n\nexport interface ServiceResponse extends Payload {\n    asyncId: string; // response correlation id\n    records : SecretRecord[];\n}\n\nexport interface RequestState extends ServiceRequest {\n    validationRequestId: string; // internal, to match response\n    validationResponse?: any;\n    clientAddress: string;\n}\n\nexport type ServiceDeclarationTemplate = Partial<ServiceDeclaration> & { serviceDeclarationId: string };\n\nexport interface ServiceProviderState { \n    db: SecretRecord[];\n    services: ServiceConfig[];\n    inflight: RequestState[]; // requests received but not properly responded\n    declTemplate?: ServiceDeclarationTemplate[];\n}\n","import { GenericMessageHandler, Payload, Message, addHandlerClass } from \"../Base\";\nimport { ConsentServicePS, ConsentServiceState, ConsentService } from \"./types\";\nimport { address2org } from \"../../util\";\n\n\nexport interface ValidationRequest extends Payload {\n    type: typeof ValidationRequestHandler.name;\n    asyncId: string; // internal identifier to help SP to match answer to a request\n    partyId: string;\n    consentReference: string;\n    requestReference: string;\n}\n\nexport const ValidationResponseTypeName = \"CS/validateConsentReference/response\";\nexport interface ValidationResponse extends Payload {\n    type: typeof ValidationResponseTypeName;\n    asyncId: string; // internal identifier. same as in the request\n    valid: boolean;\n    consentReference?: string;\n    consentExpiration?: string; // timestamp\n    validationExpiration?: string;\n    dataSubjectId?: string;\n    clientId?: string;\n    purposeDeclarationId?: string;\n    serviceDeclarationId?: string[];\n}\n\nconst NotValidResponse : ValidationResponse = {\n    type: ValidationResponseTypeName,\n    asyncId: \"\",\n    valid: false,\n}\n\nclass ValidationRequestHandler extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ValidationRequest, ValidationRequestHandler> {\n    name = \"CS/validateConsentReference\";\n\n    notValid(cs: ConsentServicePS, action: Message<ValidationRequest>): ConsentServicePS {\n        return this.withResponse<ValidationResponse>(cs, action, { ...NotValidResponse, asyncId: action.message.asyncId });\n    }\n\n    handle(cs: ConsentServicePS, action: Message<ValidationRequest>): ConsentServicePS {\n        let consent = cs.mem.db.consents.find(c => c.consentReference === action.message.consentReference);\n\n        if (consent === undefined) {\n            console.log(\"No such consent found: \", action.message.consentReference);\n            return this.notValid(cs, action);\n        }\n\n        let now = action.now!;\n\n        if (consent.revoked || now < consent.validFrom || now > consent.validUntil) {\n            console.log(`Consent ${consent} is not valid`);\n            return this.notValid(cs, action);\n        }\n\n        let sender = address2org(action.sender);\n\n        // find services that the sender of the request is allowed to provide under the consent in question\n        let purposeDeclaration = cs.mem.db.purposeDeclarations.find(\n            pd => (pd.clientId === consent!.clientId && pd.purposeDeclarationId === consent!.purposeDeclarationId)\n        );\n\n        if (purposeDeclaration === undefined) {\n            console.error(\"Cannot find purposeDeclaration that matches to an existing consent?\");\n            return this.notValid(cs, action);\n        }\n\n        // services that the asking party is allowed to provide with this consent\n        let services = (purposeDeclaration.services\n            .filter(s => s.serviceProviderId === sender)\n            .map(s => s.serviceDeclarationId)\n        );\n\n        if (sender === consent.clientId) {\n            let response: ValidationResponse = {\n                type: ValidationResponseTypeName,\n                asyncId: action.message.asyncId,\n                valid: true,\n                consentReference: action.message.consentReference,\n                consentExpiration: new Date(consent.validUntil * 1000).toISOString(),\n                dataSubjectId: consent.dataSubject,\n                clientId: consent.clientId,\n                purposeDeclarationId: consent.purposeDeclarationId,\n                // this is not empty if the client and service provider are the same\n                // (data repurposing using the consent)\n                serviceDeclarationId: services,\n            }\n            return this.withResponse(cs, action, response);\n        }\n\n        // it was not the party that declared the purpose. if it is party whose service declaration was\n        // referenced from the purpose declaration, then it still might get the answer\n        if (services.length > 0) {\n            let response: ValidationResponse = {\n                type: ValidationResponseTypeName,\n                asyncId: action.message.asyncId,\n                valid: true,\n                consentReference: action.message.consentReference,\n                consentExpiration: new Date(consent.validUntil * 1000).toISOString(),\n                dataSubjectId: consent.dataSubject,\n                clientId: consent.clientId,\n                serviceDeclarationId: services,\n            }\n            return this.withResponse(cs, action, response);\n        }\n\n        // not the client, not the service provider => not authorized to get anything.\n        return this.notValid(cs, action);\n    }\n}\n\nexport const validateConsentReference = addHandlerClass<ValidationRequest, ValidationRequestHandler>(ConsentService, ValidationRequestHandler);\n\n","import { UsageRecord, ConsentServiceState, ConsentServicePS, ConsentService } from \"./types\";\nimport { GenericMessageHandler, Message, addHandlerClass, Payload, updateDb } from \"../Base\";\n\ninterface ServiceUseMessage extends UsageRecord, Payload {\n    type: typeof ReportServiceUseMessage.name;\n}\n\nclass ReportServiceUseMessage extends GenericMessageHandler<ConsentServiceState, ConsentServicePS, ServiceUseMessage, ReportServiceUseMessage> {\n    name: string = \"CS/reportServiceUsage\";\n\n    addUsageRecord(cs: ConsentServicePS, sd: UsageRecord) {\n        return updateDb(cs, { usageLog : cs.mem.db.usageLog.concat(sd)});\n    }\n\n    handle (cs: ConsentServicePS, msg: Message<ServiceUseMessage>) {\n        return this.withOkResponse(this.addUsageRecord(cs, {...msg.message, type: undefined } as UsageRecord), msg);\n    }\n}\n\nexport const reportServiceUse = addHandlerClass<ServiceUseMessage, ReportServiceUseMessage>(ConsentService, ReportServiceUseMessage);\n\n","import { GenericMessageHandler, Payload, Message, message, addHandlerClass, ErrorPayload } from \"../Base\";\nimport { ServiceProviderState, ServiceProviderPS, ServiceProviderIS, SecretRecord, ServiceRequest, requestTypeName, RequestState, ServiceConfig } from \"./types\";\nimport { addServiceDeclaration } from \"../consentService/declarationAPI\";\nimport { validateConsentReference, ValidationResponse, ValidationResponseTypeName } from \"../consentService/validationAPI\";\nimport { reportServiceUse } from \"../consentService/reportingAPI\";\nimport { submitResponse } from \"../client/messages\";\nimport { hash, address2org } from \"../../util\";\nimport { UsageRecord } from \"../consentService/types\";\n\ninterface DataPayload extends Payload {\n    type: typeof DataEntryHandler.name;\n    key: string;\n    datatype?: string;\n    subject?: string;\n    data?: any;\n}\n\nclass DataEntryHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, DataPayload, DataEntryHandler> {\n    name = \"ServiceProvider/UI/addData\";\n\n    handle (spis: ServiceProviderPS, action: Message<DataPayload>): ServiceProviderPS {\n        if (action.message.datatype === undefined || action.message.datatype === \"\") {\n            return { ...spis, mem: { ...spis.mem, db: spis.mem.db.filter(r => (r.key !== action.message.key)) } };\n        }\n\n        let rec = action.message;\n        let dbrec : SecretRecord = { key: rec.key, type: rec.datatype!, subject: rec.subject!, data: rec.data! };\n\n        return { ...spis, mem: { ...spis.mem, db: spis.mem.db.concat(dbrec) } }\n    }\n}\n\nexport const addData = addHandlerClass<DataPayload, DataEntryHandler>(ServiceProviderIS, DataEntryHandler);\n\nclass SendDeclarationHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, Payload, SendDeclarationHandler> {\n    name = \"ServiceProvider/UI/declareService\";\n\n    handle(spis: ServiceProviderPS, action: Message<Payload>): ServiceProviderPS {\n        // FIXME: korrektne CS väärtus\n        return this.send(spis, message(action.arena, spis, [ spis.mem.services[0].consentService ], addServiceDeclaration()(action.message)))\n    }\n}\n\nexport const declareService = addHandlerClass(ServiceProviderIS, SendDeclarationHandler);\n\nfunction requestId(req: ServiceRequest, service: ServiceConfig): string {\n    let input = req.clientId + req.consentReference + req.requestReference + \n             req.serviceName + req.subjectId + service.consentService;\n    \n    return hash(input);\n}\n\nclass ProtectedRequestHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, ServiceRequest, ProtectedRequestHandler> {\n    name = requestTypeName;\n    handle(spis: ServiceProviderPS, action: Message<ServiceRequest>): ServiceProviderPS {\n\n        function _send<P extends Payload>(receivers: string[], m: P): Message<P> {\n            return message(action.arena, spis, receivers, m);     \n        }\n\n        let req : ServiceRequest = action.message;\n        // validate request (find service record from config)\n        let service = spis.mem.services.find(s => s.serviceName === req.serviceName);\n        if (service === undefined) {\n            // no reporting -- \"the request did not reach the relevant endpoint\"\n            return this.withErrorResponse(spis, action, \"invalid_request\");\n        }\n\n        if (req.clientId !== address2org(action.sender)) {\n            // FIXME: here we COULD report something?\n            return this.withErrorResponse(spis, action, \"invalid_request\");\n        }\n\n        if(!req.consentReference) {\n            const report : UsageRecord = { \n                result: \"ACCESS_DENIED\", \n                clientId : req.clientId,\n                subjectId: req.subjectId,\n                serviceDeclarationIds: service.requiredServiceDeclarationIds, \n                requestReference: req.requestReference,\n                serviceProviderId: spis.name,\n                usageTime : action.now!,\n            }\n            return this.send(\n                this.send(\n                    spis,\n                    _send([service.consentService],reportServiceUse()(report))\n                ),\n                _send([action.clientAddress], {type : \"error\", error : \"ACCESS_DENIED\"} as ErrorPayload)\n            )\n        }\n\n        // store inflight query\n        // spis.mem.inflight += [inflight]\n        let reqState : RequestState = { \n            ...req,\n             validationRequestId: requestId(req, service),\n             clientAddress: action.sender,\n        }\n        let withInfligh : ServiceProviderPS = {\n            ...spis, mem: { ...spis.mem, inflight: spis.mem.inflight.concat(reqState) }\n        };\n\n        // send consent reference validation request\n        return this.send(\n            withInfligh, \n            message(\n                action.arena,\n                 withInfligh,\n                  [ service.consentService ],\n                  validateConsentReference()({\n                      asyncId: reqState.validationRequestId,\n                      partyId: spis.name,\n                      consentReference: req.consentReference,\n                      requestReference: req.requestReference,\n                  })\n            )\n        );\n    }\n}\n\nexport const submitRequest = addHandlerClass<ServiceRequest, ProtectedRequestHandler>(ServiceProviderIS, ProtectedRequestHandler);\n\n\nclass ValidationResponseHandler extends GenericMessageHandler<ServiceProviderState, ServiceProviderPS, ValidationResponse, ValidationResponseHandler> {\n    name = ValidationResponseTypeName;\n\n    handle(spis: ServiceProviderPS, action: Message<ValidationResponse>): ServiceProviderPS {\n\n        function _send<P extends Payload>(receivers: string[], m: P): Message<P> {\n            return message(action.arena, spis, receivers, m);     \n        }\n        \n        const reqState = spis.mem.inflight.find(ifr => ifr.validationRequestId === action.message.asyncId);\n        const resp = action.message;\n\n        function removeInflight(spis: ServiceProviderPS): ServiceProviderPS {\n            return { ...spis, mem: { ...spis.mem, inflight: spis.mem.inflight.filter(\n                ifr => (reqState === undefined || ifr.requestReference !== reqState.requestReference)\n            ) }};\n        }\n\n\n        if (reqState === undefined) {\n            console.error(\"Failed to find original inflight request, ignoring the response.\");\n            return spis;\n        }\n\n        const service = spis.mem.services.find(s => s.serviceName === reqState.serviceName);\n        if (service === undefined) {\n            console.error(\"Failed to find the service specified in the original inflight request, ignoring the response.\");\n            return removeInflight(spis);\n        }\n\n        const usageReport : UsageRecord = { \n            result: \"OK\", // will be overwritten\n            clientId : reqState.clientId,\n            subjectId: reqState.subjectId,\n            // fixme: feili korral peaks serviceDeclarationIds olema need, mida kysiti\n            // fixme: ja positiivse vastuse korral need, mille j'rgi teenust tegelt osutati\n            serviceDeclarationIds: action.message.serviceDeclarationId!, \n            consentReference: reqState.consentReference,\n            requestReference: reqState.requestReference,\n            serviceProviderId: spis.name,\n            usageTime : action.now!,\n        }\n\n        if (resp.clientId !== reqState.clientId \n                || resp.consentReference !== reqState.consentReference \n                || resp.dataSubjectId !== reqState.subjectId\n                || !resp.valid) {     \n            return this.send(\n                this.send(\n                    removeInflight(spis),\n                    _send([service.consentService],reportServiceUse()({...usageReport, result : \"ACCESS_DENIED\"}))\n                ),\n                _send([reqState.clientAddress], {type : \"error\", error : \"ACCESS_DENIED\"} as ErrorPayload)\n            )\n        };\n    \n        return this.send(\n            this.send(\n                removeInflight(spis),\n                _send([service.consentService], reportServiceUse()({...usageReport, result : \"OK\"}))\n            ),\n            _send(\n                [reqState.clientAddress],\n                submitResponse()({\n                    records : spis.mem.db\n                        .filter(x => x.subject === reqState.subjectId)\n                        .filter(x => service.returnedDatatypes.includes(x.type)),\n                    asyncId : reqState.requestReference    \n                })\n            )\n        );\n    }\n}\n\nexport const validationResponse = addHandlerClass<ValidationResponse, ValidationResponseHandler>(ServiceProviderIS, ValidationResponseHandler);\n","import { addHandlerClass, Payload, GenericMessageHandler, Message, message, ErrorPayload, updateDb } from \"../Base\";\nimport { ClientIS, ClientState, ClientPS } from \"./types\";\n\nimport { addPurposeDeclaration } from \"../consentService/declarationAPI\";\nimport { getConsentReference, ConsentReferenceResponse, ConsentReferenceResponseTypeName } from \"../consentService/referenceAPI\";\n\nimport { submitRequest } from \"../serviceProvider/messages\";\nimport { ServiceResponse, responseTypeName } from \"../serviceProvider/types\";\n\nimport { hash, address2org } from \"../../util\";\nimport { validateConsentReference } from \"../consentService/validationAPI\";\n\n\ninterface LoginMessage extends Payload {\n    type: typeof LoginMessageHandler.name;\n    user?: string;\n}\n\nclass LoginMessageHandler extends GenericMessageHandler<ClientState, ClientPS, LoginMessage, LoginMessageHandler> {\n    name = \"Client/UI/login\";\n\n    handle(cs: ClientPS, action: Message<LoginMessage>): ClientPS {\n        // reset cached responses when logging in.\n        return { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, user: action.message.user, service: undefined, response: [] } } };\n    }\n}\n\nexport const loginMessage = addHandlerClass<LoginMessage, LoginMessageHandler>(ClientIS, LoginMessageHandler);\n\ninterface SelectServiceMessage extends Payload {\n    type: typeof SelectServiceMessageHandler.name;\n    service?: string;\n}\n\nclass SelectServiceMessageHandler extends GenericMessageHandler<ClientState, ClientPS, SelectServiceMessage, SelectServiceMessageHandler> {\n    name = \"Client/UI/selectService\";\n\n    handle(cs: ClientPS, action: Message<SelectServiceMessage>): ClientPS {\n        let _cs = { ...cs, mem: { ...cs.mem, ui: { ...cs.mem.ui, service: action.message.service, response: [] } } };\n\n        if (_cs.mem.ui.service !== undefined) {\n            // if cached consentref is missing (not asked or known to not exist), ask automatically for new\n            let cachedConsentRefs = _cs.mem.db.consentRefByUser[_cs.mem.ui.user!];\n            let cachedConsentRef = cachedConsentRefs === undefined ? undefined : cachedConsentRefs[_cs.mem.ui.service!];\n            if (cachedConsentRef === undefined || cachedConsentRef === null) {\n                return this.send(_cs, message(action.arena, cs, [cs.mem.db.consentServiceId], \n                    getConsentReference({ \n                        clientId: address2org(cs.name),\n                        subjectId: cs.mem.ui.user,\n                        purposeDeclarationId: action.message.service,\n                        callbackURL: cs.name, // actual address for callback message\n                    })()\n                ));\n            }\n        }\n\n        return _cs;\n    }\n}\n\nexport const selectServiceMessage = addHandlerClass<SelectServiceMessage, SelectServiceMessageHandler>(ClientIS, SelectServiceMessageHandler);\n\n\n\nclass SendDeclarationHandler extends GenericMessageHandler<ClientState, ClientPS, Payload, SendDeclarationHandler> {\n    name = \"Client/UI/declarePurpose\";\n\n    handle(cis: ClientPS, action: Message<Payload>): ClientPS {\n        return this.send(cis, message(action.arena, cis, [ cis.mem.db.consentServiceId ], addPurposeDeclaration()(action.message)))\n    }\n}\n\nexport const declarePurpose = addHandlerClass(ClientIS, SendDeclarationHandler);\n\ninterface FetchConsentReferencePayload extends Payload {\n    type: typeof FetchConsentReferenceHandler.name;\n    purposeDeclarationId: string;\n}\n\nclass FetchConsentReferenceHandler extends GenericMessageHandler<ClientState, ClientPS, FetchConsentReferencePayload, FetchConsentReferenceHandler> {\n    name = \"Client/UI/fetchConsentReference\";\n\n    handle(cis: ClientPS, action: Message<FetchConsentReferencePayload>): ClientPS {\n        return this.send(\n            updateDb<typeof cis.mem.db, ClientState>(cis, { \n                consentRefByUser: updateCSRef(\n                    cis.mem.db.consentRefByUser,\n                    cis.mem.ui.user!,\n                    action.message.purposeDeclarationId,\n                    undefined\n                )\n             }), \n            message(action.arena, cis, [cis.mem.db.consentServiceId], getConsentReference({\n                clientId: address2org(cis.name),\n                purposeDeclarationId: action.message.purposeDeclarationId,\n                subjectId: cis.mem.ui.user,\n                callbackURL: cis.name, // actual address for callback message\n            })()\n        ))\n    }\n}\n\nexport const fetchConsentReference = addHandlerClass<FetchConsentReferencePayload, FetchConsentReferenceHandler>(ClientIS, FetchConsentReferenceHandler);\n\nfunction updateCSRef<T extends { [k: string]: any }>(csByUser: T, user: string, purposeDeclarationId: string, consentReference?: string | null): T {\n    return {\n        ...csByUser,\n        [user]: { ...csByUser[user], [purposeDeclarationId]: consentReference }\n    };\n}\n\nclass ConsentReferenceResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ConsentReferenceResponse, ConsentReferenceResponseHandler> {\n    name = ConsentReferenceResponseTypeName;\n\n    handle(cis: ClientPS, action: Message<ConsentReferenceResponse>): ClientPS {\n        return { ...cis, mem: { ...cis.mem, db: { \n            ...cis.mem.db,\n            consentRefByUser: updateCSRef(\n                cis.mem.db.consentRefByUser,\n                cis.mem.ui.user!,\n                action.message.purposeDeclarationId,\n                action.message.consentReference\n            )\n        } } };\n    }\n}\n\nexport const handleConsentRefernceResponse = addHandlerClass<ConsentReferenceResponse, ConsentReferenceResponseHandler>(ClientIS, ConsentReferenceResponseHandler);\n\ninterface ExecuteMessage extends Payload {\n    type: typeof ExecuteRequestHandler.name;\n    requestReference: string; // generated in UI because it should not be done here.\n    purposeId: string;\n    serviceAddress?: string; // only execute one request.\n    serviceName?: string;\n}\n\nclass ExecuteRequestHandler extends GenericMessageHandler<ClientState, ClientPS, ExecuteMessage, ExecuteRequestHandler> {\n    name = \"Client/UI/executeRequest\";\n\n    handle(cis: ClientPS, action: Message<ExecuteMessage>): ClientPS {\n        let req = action.message;\n\n        let userConsentRefs = cis.mem.db.consentRefByUser[cis.mem.ui.user!];\n        let consentReference = userConsentRefs === undefined ? undefined : userConsentRefs[req.purposeId];\n\n        let conf = cis.mem.config.find(c => c.purposeDeclarationId === req.purposeId);\n        if (conf === undefined) {\n            console.error(\"Unknown purpose? \", req);\n            return cis;\n        }\n\n        // send request for all services defined in configuration, or to those that match.\n        return (conf.services\n            .filter(service => ((req.serviceAddress === undefined || req.serviceAddress === service.serviceAddress)\n                    && (req.serviceName === undefined || req.serviceName === service.serviceName)))\n            .reduce((_cis, service) => {\n            let requestReference = hash(req.requestReference + service.serviceName + service.serviceAddress);\n            let cis = undefined;\n            \n            // replace or add response record for this particular purpose/serviceprovider/service\n            let newResponses = (_cis.mem.ui.response || []).filter(\n                r => !(r.purposeDeclarationId === req.purposeId \n                        && r.serviceAddress === service.serviceAddress \n                        && r.serviceName === service.serviceName)\n            ).concat({\n                requestReferenceId: requestReference,\n                purposeDeclarationId: req.purposeId,\n                serviceAddress: service.serviceAddress,\n                serviceName: service.serviceName,\n                data: null,\n            })\n\n            let __cis = { ..._cis, mem: { ..._cis.mem, ui: { \n                ..._cis.mem.ui,\n                 response: newResponses,\n            } } };\n\n            return this.send(__cis, message(action.arena, __cis, [service.serviceAddress], submitRequest({\n                clientId: address2org(__cis.name),\n                serviceName: service.serviceName,\n                subjectId: __cis.mem.ui.user,\n                consentReference: consentReference!,\n                requestReference: requestReference,\n            })()))\n        }, cis));\n    }\n}\n\nexport const executeRequest = addHandlerClass<ExecuteMessage, ExecuteRequestHandler>(ClientIS, ExecuteRequestHandler);\nexport function generateRequestReference() : string {\n    return hash(\"\" + ((Math.random() * 1000000) | 0));\n}\n\n\nclass ServiceResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ServiceResponse, ServiceResponseHandler> {\n    name = responseTypeName;\n\n    handle(cis: ClientPS, action: Message<ServiceResponse>): ClientPS {\n        return { ...cis, mem: { ...cis.mem, ui: {\n            ...cis.mem.ui,\n            response: (cis.mem.ui.response || []).map(\n                r => {\n                    if (r.requestReferenceId === action.message.asyncId) {\n                        return { ...r, data: action.message.records }\n                    } else {\n                        return r;\n                    }\n                }\n            )\n        }}}\n    }\n\n}\n\nexport const submitResponse = addHandlerClass<ServiceResponse, ServiceResponseHandler>(ClientIS, ServiceResponseHandler);\n\nclass ErrorResponseHandler extends GenericMessageHandler<ClientState, ClientPS, ErrorPayload, ErrorResponseHandler> {\n    name = \"error\";\n\n    handle(cis: ClientPS, action: Message<ErrorPayload>): ClientPS {\n        switch (action.message.error) {\n            // assume the respone came for logged in user and for selected service\n            case \"consent_not_found\":\n                return updateDb<typeof cis.mem.db, ClientState>(cis, { \n                    consentRefByUser: updateCSRef(\n                        cis.mem.db.consentRefByUser,\n                        cis.mem.ui.user!,\n                        cis.mem.ui.service!,\n                        null\n                    )\n                });\n        }\n\n        console.log(\"Unknown error, ignoring: \", action);\n        return cis;\n    }\n}\n\naddHandlerClass<ErrorPayload, ErrorResponseHandler>(ClientIS, ErrorResponseHandler);\n\ninterface DumpConsentReferencePayload extends Payload {\n    type: typeof DumpConsentRefCacheHandler.name;\n    purposeDeclarationId?: string;\n}\n\nclass DumpConsentRefCacheHandler extends GenericMessageHandler<ClientState, ClientPS, DumpConsentReferencePayload, DumpConsentRefCacheHandler> {\n    name = \"CS/UI/dumpConsentRefCache\";\n\n    handle(cis: ClientPS, action: Message<DumpConsentReferencePayload>): ClientPS {\n        if (action.message.purposeDeclarationId !== undefined) {\n            return updateDb<typeof cis.mem.db, ClientState>(cis, { \n                consentRefByUser: updateCSRef(\n                    cis.mem.db.consentRefByUser, cis.mem.ui.user!, action.message.purposeDeclarationId, undefined\n                )\n            });\n        }\n        return updateDb<typeof cis.mem.db, ClientState>(cis, { consentRefByUser: {} });\n    }\n}\n\nexport const dumpConsentRefCache = addHandlerClass<DumpConsentReferencePayload, DumpConsentRefCacheHandler>(ClientIS, DumpConsentRefCacheHandler);\n\ninterface ValidateConsentRefMessage extends Payload {\n    consentServiceId: string;\n    consentReference: string;\n}\n\nclass ValidateConsentRefMessageHandler extends GenericMessageHandler<ClientState, ClientPS, ValidateConsentRefMessage, ValidateConsentRefMessageHandler> {\n    name = \"Client/UI/validateConsentRef\";\n\n    handle(cis: ClientPS, action: Message<ValidateConsentRefMessage>): ClientPS {\n        return this.send(\n            cis, \n            message(action.arena, cis, [action.message.consentServiceId || cis.mem.db.consentServiceId],\n                validateConsentReference({ \n                    partyId: cis.name,\n                    consentReference: action.message.consentReference\n                })()\n            )\n        );\n    }\n}\n\nexport const validateConsentRef = addHandlerClass<ValidateConsentRefMessage, ValidateConsentRefMessageHandler>(ClientIS, ValidateConsentRefMessageHandler);\n","import * as React from \"react\";\nimport { ProcessAndArena, Message, message } from \"../Base\";\nimport { ClientState } from \"./types\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { SimpleSend } from \"../../components/SendButton\";\nimport { loginMessage, selectServiceMessage, fetchConsentReference, executeRequest, generateRequestReference } from \"./messages\";\nimport { connect } from \"react-redux\";\nimport { __, fullname } from \"../../i18n\";\n\ninterface ClientViewProps extends ProcessAndArena<ClientState> {\n    t: any;\n    send: (props: ClientViewProps, values?: any) => Message<any>;\n}\n\n\nconst LOGIN: ClientViewState = \"login\";  // no authenticated user\nconst SELECT_SERVICE: ClientViewState = \"selectService\"; // user authenticated, service not selected\nconst WAIT_FOR_CONSENT_REF: ClientViewState = \"waitForConsent\"; //  no idea if user has consent\nconst CONSENT_NOT_FOUND: ClientViewState = \"consentNotFound\"; // prompt for consent\nconst SERVICE_V1: ClientViewState = \"serviceV1\";\n\ntype ClientViewState = \"login\" | \"selectService\" | \"waitForConsent\" | \"consentNotFound\" | \"serviceV1\";\n\ninterface State {\n    view: ClientViewState;\n    loading: boolean;\n}\n  \n  const Header = ({t, props} : {t: any; props: ClientViewProps}) => (\n  <div className=\"app-header\">\n    <SimpleSend arena={props.arena} owner={props.process} className=\"btn btn-success btn-health\" text={ t('logout') } message={ loginMessage() }/>\n    <div className=\"app-user-icon\">\n      <img alt=\"user icon\" src={require('./../../static/assets/images/user-icon.svg')} />\n    </div>\n    <p className=\"app-user\">{ t('hello').replace(\"USERNAME\", fullname(props.process.mem.ui.user!)) }</p>\n  </div>\n);\n\nfunction send(props: ClientViewProps, values?: any): Message<any> {\n    return message(props.arena, props.process, [props.process.name], values());\n}\n\nfunction currentView(m: ClientState): ClientViewState {\n    if (m.ui.user === undefined) {\n        return LOGIN;\n    } else if (m.ui.service === undefined) {\n        return SELECT_SERVICE;\n    } else if (m.db.consentRefByUser[m.ui.user] === undefined || \n            m.db.consentRefByUser[m.ui.user][m.ui.service] === undefined) {\n        return WAIT_FOR_CONSENT_REF;\n    } else if (m.db.consentRefByUser[m.ui.user][m.ui.service] === null) {\n        return CONSENT_NOT_FOUND;\n    } else {\n        return SERVICE_V1;\n    }\n}\n\nclass ClientView_ extends React.PureComponent<ClientViewProps, State> {\n\n  constructor(props: ClientViewProps) {\n    super(props);\n      this.state = { loading: false, view: currentView(props.process.mem) };\n      switch (this.state.view) {\n        case WAIT_FOR_CONSENT_REF:\n          this.sendMessagesFor(this.state.view);\n      }\n  }\n\n  componentDidMount() {\n    this.componentDidUpdate();    \n  }\n\n  componentDidUpdate() {\n    let actualView = currentView(this.props.process.mem);\n    if (actualView !== this.state.view) {\n      this.setState({ view: actualView });\n    }\n  }\n\n  sendMessagesFor = (view: ClientViewState) => {\n    const mem = this.props.process.mem;\n    switch (view) {\n        case WAIT_FOR_CONSENT_REF:\n            if (mem.ui.user !== undefined && mem.ui.service !== undefined && (\n                    mem.db.consentRefByUser[mem.ui.user] === undefined ||\n                    mem.db.consentRefByUser[mem.ui.user][mem.ui.service] === undefined ||\n                    mem.db.consentRefByUser[mem.ui.user][mem.ui.service] === null)\n            ) {\n                this.props.send(this.props, fetchConsentReference({ purposeDeclarationId: mem.ui.service }));\n            }\n            return;\n\n        case SERVICE_V1:\n            this.props.send(this.props, executeRequest({\n                requestReference: generateRequestReference(),\n                purposeId: mem.ui.service }));\n            return;\n    }\n  }\n\n  state = {\n    view: LOGIN,\n    loading: false\n  };\n\n  changeView = (view: ClientViewState, withMessages = true) => {\n    this.setState({ loading: true });\n    if (withMessages) {\n        this.sendMessagesFor(view);\n    }\n    setTimeout(() => {\n      this.setState({loading: false, view: view});\n    }, 600);\n  };\n\n  render() {\n    const cis = this.props.process;\n    const m = cis.mem;\n    const t = this.props.t;\n\n    const returnButton = (\n      <SimpleSend\n        arena={this.props.arena}\n        owner={this.props.process}\n        className=\"btn btn-light border\"\n        onClick={() => this.changeView(SELECT_SERVICE)}\n        message={selectServiceMessage()}\n        text={ t(\"return\") }\n      />\n    );\n\n    switch (this.state.loading) {\n      case true:\n      return (\n        <div className=\"d-flex align-items-center\">\n          <strong>Loading...</strong>\n          <div className=\"spinner-border ml-auto\" role=\"status\" aria-hidden=\"true\"></div>\n        </div>\n      );\n      default:\n        switch (this.state.view) {\n          case LOGIN:\n          return (\n            <div><form>\n                <h4>{ t(\"please_login\") }</h4>\n                <div>\n                  <div className=\"input-group\">\n                    <input className=\"form-control\" size={10} name=\"user\" defaultValue=\"47302200234\"/>\n                    <div className=\"input-group-append\">\n                      <SimpleSend\n                          arena={this.props.arena}\n                          owner={this.props.process}\n                          className=\"btn btn-light border\"\n                          onClick={() => this.changeView(SELECT_SERVICE)}\n                          message={loginMessage()}\n                          text={ t(\"login\") }\n                      />\n                    </div>\n                  </div>\n                </div>\n                <p className=\"mt-4 mb-0\">\n                    <img alt=\"illustration\" src={require('./../../static/assets/images/login.svg')} width=\"280\" />\n                </p>\n            </form></div>\n          );\n          case SELECT_SERVICE:\n          return (\n            <div>\n              <Header t={t} props={this.props} />\n          <h4>{ t(\"choose_service\") }</h4>\n              {\n                  this.props.process.mem.config.map(\n                      service => {\n                          return (\n                            <SimpleSend \n                                key={ service.purposeDeclarationId }\n                                className=\"btn btn-dark mt-2 mr-2\"\n                                arena={this.props.arena}\n                                owner={this.props.process}\n                                onClick={() => this.changeView(WAIT_FOR_CONSENT_REF)}\n                                message={selectServiceMessage({ service: service.purposeDeclarationId })}\n                                text={ t(\"service\", service.purposeDeclarationId, \"name\") }\n                             />                \n                          )\n                      }\n                  )\n              }\n            </div>\n          );\n          case WAIT_FOR_CONSENT_REF:\n              return (\n                  <div>\n                      <Header t={t} props={this.props} />\n                      <h4>{ t(\"checking_consent\") }</h4>\n                      <p className=\"text-left\">{ t(\"retry_if_timed_out\") }</p>\n                      <SimpleSend\n                            className=\"btn btn-dark\"\n                            arena={this.props.arena}\n                            owner={this.props.process}\n                            message={fetchConsentReference({ purposeDeclarationId: m.ui.service })}\n                            text={ t('retry-fetch') }\n                      />\n                  </div>\n              );\n          case CONSENT_NOT_FOUND:\n          return (\n            <div>\n              <Header t={t} props={this.props} />\n              <h4>{ t(\"service\", m.ui.service!, \"consent-header\") }</h4>\n              <p className=\"text-left\">\n                <small dangerouslySetInnerHTML={{__html: t(\"service\", m.ui.service!, \"consent-intro\")}} />\n              </p>\n              <p>\n                 <button className=\"btn btn-lg btn-primary\" onClick={ev => window.open(\"/ui/csui\", this.props.arena + \" - \" + m.db.consentServiceId) }>Annan nõusoleku</button>\n              </p>\n              <p>{ returnButton }</p>\n            </div>\n          );\n          case SERVICE_V1:\n              return (\n                  <div>\n                      <Header t={t} props={this.props} />\n                      <h4>{ t(\"consented_data\") }</h4>\n                      {\n                        (m.ui.response || []).filter(\n                            r => r.purposeDeclarationId === m.ui.service\n                        ).map(\n                            r => (\n                                <span className=\"card\" key={r.serviceAddress + \" \" + r.serviceName}>\n                                    <pre className=\"text-left\">\n                                        {r.serviceAddress}/{r.serviceName}: { JSON.stringify(r.data, undefined, \" \") }\n                                    </pre>\n                                </span>\n                            )\n                        )\n                      }\n                    <p>\n                      <SimpleSend\n                        owner={this.props.process}\n                        arena={this.props.arena}\n                        message={executeRequest({\n                          requestReference: generateRequestReference(),\n                          purposeId: m.ui.service\n                      })} text={ t('load-consented-data') } />\n                    </p>\n                    <p>{ returnButton }</p>\n                  </div>\n              )\n          default:\n          return <div>Unimplemented view: {this.state.view}</div>\n        }\n    }\n  }\n}\n\nconst ClientView = connect(null, { send })(ClientView_);\n\nconst EnduserUI : React.FC<ProcessAndArena<ClientState>> = ({process, arena}) => {\n\n    const t = (...k: string[]) => __({arena, process}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n\n    return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"lg\" bsPrefix=\"client-app modal\">\n          <Modal.Header>\n            <Modal.Title>{ t('title') }</Modal.Title>\n          </Modal.Header>\n          <Modal.Body>\n            <ClientView arena={arena} process={process} t={t}/>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"outline-dark\" onClick={handleClose}>{ t('close') }</Button>\n          </Modal.Footer>\n        </Modal>\n        <Button variant=\"success\" className=\"mr-2 btn-health\" onClick={handleShow}>{t('open-end-user-view')}</Button>\n        </>\n      )\n}\n  \n\nexport default EnduserUI;","import { ProcessAndArena } from \"../Base\";\nimport { ClientState, ClientPS, PurposeDeclarationTemplate, ClientConfig } from \"./types\";\nimport React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { SimpleSend } from \"../../components/SendButton\";\nimport { declarePurpose, executeRequest, fetchConsentReference, generateRequestReference, dumpConsentRefCache, selectServiceMessage, validateConsentRef } from \"./messages\";\nimport EnduserUI from \"./EnduserUI\";\nimport { __, business } from \"../../i18n\";\nimport { address2org } from \"../../util\";\n\n\ninterface ClientViewProps extends ProcessAndArena<ClientState> {\n    process: ClientPS;\n}\n\ntype SDRef = {\n    serviceProviderId: string;\n    serviceDeclarationId: string;\n}\n\nfunction addSDRef(ev: any, opts: SDRef[], setOpts: React.Dispatch<React.SetStateAction<SDRef[]>> ) {\n    ev.preventDefault();\n    let f = ev.currentTarget.form;\n\n    let spId = f._spId.value;\n    let sdId = f._sdId.value;\n\n    if (!spId.match(\"^[!-~]+$\") || !sdId.match(\"^[!-~]+$\")) {\n        return;\n    }\n    \n    setOpts(old => old.concat({ serviceProviderId: spId, serviceDeclarationId: sdId }));\n    f._spId.value = f._sdId.value = \"\";\n}\n\nfunction prefillPurposeDeclaration(ev: any, decls: PurposeDeclarationTemplate[] | undefined, setOpts: React.Dispatch<React.SetStateAction<SDRef[]>> ) {\n    ev.preventDefault();\n  \n    let declId = ev.currentTarget.value;\n  \n    let form = ev.currentTarget.form;\n    let decl = decls!.find(d => d.purposeDeclarationId! === declId);\n    if (decl === undefined) {\n      return;\n    }\n  \n    form[\"name\"].value = decl.name;\n    form[\"purposeDeclarationId\"].value = decl.purposeDeclarationId;\n    form[\"description\"].value = decl.description;\n    if (decl.services !== undefined) {\n        setOpts(decl.services);\n    }\n  }\n  \n  function declarationPrefill(sp: ClientPS, setOpts: React.Dispatch<React.SetStateAction<SDRef[]>>) {\n    if (sp.mem.declTemplate === undefined || sp.mem.declTemplate.length === 0) {\n      return <></>;\n    }\n  \n    return (\n      <div className=\"form-group\">\n        <label htmlFor=\"prefilled\">Eeltäidetud deklaratsiooni kiirvalik</label>\n        <select \n            className=\"form-control\" \n            id=\"prefilled\" \n            onChange={ ev => prefillPurposeDeclaration(ev, sp.mem.declTemplate, setOpts) }\n            defaultValue=\"\">\n          <option key=\"none\" value=\"\">... vali eeltäidetud deklaratsioon ...</option>\n          {\n            sp.mem.declTemplate.map(dt => (\n              <option key={ dt.purposeDeclarationId } value={ dt.purposeDeclarationId }>{ dt.name! }</option>\n            ))\n          }\n        </select>\n      </div>\n    );\n  }\n  \n\nconst DeclarePurposePopup : React.FC<ClientViewProps> = ({process, arena}) => {\n\n  const t = (k: string) => __({arena, process}, k);\n  const [show, setShow] = React.useState(false);\n  const [sdrefs, setSDRefs] = React.useState([] as SDRef[]);\n  const handleClose = () => setShow(false);\n  const handleShow = () => setShow(true);\n    return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n            <Modal.Title>Eesmärgideklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n            <Modal.Body>\n              <div className=\"row\">\n                <small className=\"ml-4 mr-4 mb-4 text-center\">\n                  { t('purpose-decl-intro') }\n                </small>\n              </div>\n              <div className=\"ml-4 mr-4 mb-2 border-bottom\">\n                <h6 className=\"text-center\">{t('declarer')} { business(address2org(process.name), \"name\") } ({ address2org(process.name) })</h6>\n                <input name=\"clientId\" type=\"hidden\" value={ address2org(process.name) } />\n              </div>\n                <div className=\"row\">\n                <div className=\"col\">\n                    { declarationPrefill(process, setSDRefs) }\n                    <div className=\"form-group\">\n                    <label htmlFor=\"dIdentifier\">Eesmärgideklaratsiooni identifikaator:</label>\n                    <input name=\"purposeDeclarationId\" type=\"text\" className=\"form-control\" id=\"dIdentifier\" />\n                    <small id=\"dIdentifierHelp\" className=\"form-text text-muted\">Klientrakenduse poolt määratud eesmärgideklaratsiooni identifikaator</small>\n                    </div>\n                    <div className=\"form-group\">\n                    <label htmlFor=\"dName\">Eesmärgideklaratsiooni nimi:</label>\n                    <input name=\"name\" type=\"text\" className=\"form-control\" id=\"dName\" />\n                    <small id=\"dNameHelp\" className=\"form-text text-muted\">Eesmärgi lühike nimi kasutajale näitamiseks</small>\n                    </div>\n                </div>\n                <div className=\"col\">\n                    <div className=\"form-group\">\n                    <label htmlFor=\"dataUsage\">Andmete kasutamise eesmärk:</label>\n                    <textarea name=\"description\" className=\"form-control\" id=\"dataUsage\" rows={5} />\n                    <small id=\"dataUsageHelp\" className=\"form-text text-muted\">Andmesubjekti andmete töötlemise eesmärk. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                    </div>\n                    <div className=\"form-group\">\n                    <label htmlFor=\"services\">Kasutatavad teenused:</label>\n                        <select name=\"services\"\n                            className=\"custom-select\"\n                            multiple\n                            id=\"services\"\n                            value={ sdrefs.map(s => JSON.stringify(s)) }\n                            onChange={ () => { /* nop. use X button and adding. */ } }\n                        >\n                            {\n                                sdrefs.map(sdref => (\n                                    <option \n                                        key={ JSON.stringify(sdref) }\n                                        value={ JSON.stringify(sdref) }\n                                    >\n                                            {sdref.serviceProviderId} / {sdref.serviceDeclarationId}\n                                    </option>\n                                ))\n                            }\n                        </select>\n                        <input name=\"_spId\" placeholder=\"teenusepakkuja id\" size={10}/>\n                        <input name=\"_sdId\" placeholder=\"teenuse deklaratsiooni id\" size={10}/>\n                        <button className=\"btn-sm\" onClick={ev => addSDRef(ev, sdrefs, setSDRefs)}>+</button>\n                        <button className=\"btn-sm\" onClick={ev => { ev.preventDefault(); setSDRefs([]); }} title={ t('clear') }>X</button>\n                    </div>\n                </div>\n                </div>\n            </Modal.Body>\n            <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>Close</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text={ t('declare') } message={declarePurpose()}/>\n            </Modal.Footer>\n        </form>\n        </Modal>\n        <Button variant=\"dark\" onClick={handleShow}>\n            {t('declare')}\n        </Button>\n        </>\n    )\n}\n\n\nfunction countConsentRefs(cis: ClientPS): number {\n    let out : number = 0;\n    Object.keys(cis.mem.db.consentRefByUser).forEach(\n        k => { out += Object.keys(cis.mem.db.consentRefByUser[k]).filter(\n            pd => cis.mem.db.consentRefByUser[k][pd] !== null\n        ).length; }\n    );\n    return out;\n}\n\nfunction purposeView(t: any, purpose: ClientConfig, process: ClientPS, arena: any): React.ReactElement {\n    const consentRef = (process.mem.db.consentRefByUser[process.mem.ui.user!] || {})[purpose.purposeDeclarationId];\n    const consentRefDesc = (consentRef === undefined ? t('consent-ref-not-asked') : consentRef === null ? t('consent-ref-not-found') : consentRef);\n\n    return (\n        <span className=\"card small\" key={purpose.purposeDeclarationId}>\n            <div className=\"w-100 row no-gutters\">\n                <div className=\"col-auto flex-fill\">\n                    <p>\n                        { t(\"service\", purpose.purposeDeclarationId, \"name\") }<br/>\n                        { t('consent-ref') }{ consentRefDesc }\n                    </p>\n                </div>\n                <div className=\"col-auto\">\n                    <SimpleSend className=\"btn btn-sm btn-outline-secondary\" owner={process} arena={arena} message={executeRequest({\n                        requestReference: generateRequestReference(),\n                        purposeId: purpose.purposeDeclarationId\n                    })} text=\"GO\" title=\"Tee päring kõigile selle eesmärgi teenustele\"/>\n                    <SimpleSend className=\"btn btn-sm btn-outline-secondary\" owner={process} arena={arena} message={fetchConsentReference({\n                        purposeDeclarationId: purpose.purposeDeclarationId\n                    })} text={ t('fcr') }\n                        title=\"Küsi nõusolekuviide uuesti\"\n                    />\n                    { consentRef &&\n                        <SimpleSend className=\"btn btn-sm btn-outline-secondary\" owner={process} arena={arena} message={validateConsentRef({\n                            consentReference: consentRef\n                        })} text=\"vcr\"\n                            title=\"Valideeri nõusolekuviide nõusolekuteenuses\"\n                        />\n                    }\n                    { consentRef &&\n                        <SimpleSend className=\"btn btn-sm btn-outline-secondary\" owner={process} arena={arena} message={dumpConsentRefCache({\n                            purposeDeclarationId: purpose.purposeDeclarationId\n                        })} text=\"rcr\"\n                            title=\"Unusta see nõusolekuviide\"\n                        />\n                    }\n\n                </div>\n            </div>\n            { /*\n            \n            <table className=\"table\">\n                <tbody>\n                    { purpose.services.map(\n                        s => {\n                            const resp = findFrom((process.mem.ui.response || []), { \n                                purposeDeclarationId: purpose.purposeDeclarationId,\n                                serviceAddress: s.serviceAddress,\n                                serviceName: s.serviceName,\n                            });\n\n                            return (\n                                <tr>\n                                    <td>{ s.serviceAddress }<br/>{ s.serviceName }</td>\n                                    <td>{ resp && resp.requestReferenceId }</td>\n                                    <td>{ resp && \n                                        (resp.data === null \n                                            ? t('response-has-no-data') \n                                            : <>{ resp.data.length }{t('data-items-returned')}</>\n                                        )\n                                    }</td>\n                                    <td>\n                                        <SimpleSend \n                                            className=\"btn btn-sm\"\n                                            owner={process}\n                                            arena={arena}\n                                            message={executeRequest({\n                                                requestReference: generateRequestReference(),\n                                                purposeId: purpose.purposeDeclarationId,\n                                                serviceAddress: s.serviceAddress,\n                                                serviceName: s.serviceName,\n                                            })} text=\"GO\"\n                                            title=\"Ainult see päring\"\n                                        />\n                                    </td>\n                                </tr>\n                            )\n                        }\n                    )}\n                </tbody>\n            </table>\n\n                    */}\n        </span>\n    )\n}\n\nfunction hasUser(cis: ClientPS): boolean {\n    return cis.mem.ui.user !== undefined;\n}\n\nexport const ClientRenderer : React.FC<ClientViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({arena, process}, ...k);\n\n    const serviceCount = Object.keys(process.mem.db.purpose).length;\n    const consentRefCount = countConsentRefs(process);\n    const responseCount = (process.mem.ui.response || []).filter(r => r.data !== null).length;\n\n    return (<div>\n        <p>{ hasUser(process) ? `${t('active-user')} : ${process.mem.ui.user}` : `${t('no-active-user')}.` }</p>\n        <p className=\"small\">\n            { /* { serviceCount } { t('services-configured') }<br/> */ }\n            { consentRefCount } { t('consent-refs-cached') }<br/>\n            { responseCount } { t('responses-cached') }\n        </p>\n        <div className=\"row mx-1\">\n            <EnduserUI arena={arena} process={process}/>\n            <DeclarePurposePopup arena={arena} process={process}/>\n        </div>\n        <div className=\"col\">\n            { consentRefCount > 0 && <SimpleSend className=\"btn-link mt-2\" owner={process} arena={arena} message={dumpConsentRefCache()} text={ t('dump-consent-ref-cache') }/> }\n            { responseCount > 0 && <SimpleSend className=\"btn-link mt-2\" owner={process} arena={arena} message={selectServiceMessage({ service: process.mem.ui.service })} text={ t('dump-response-cache') }/> }\n        </div>\n        { hasUser(process) && process.mem.config.map(p => purposeView(t, p, process, arena)) } \n      </div>);\n}\n\n\n","import { ClientPS, ClientDefaultView, ClientIS, PurposeDeclarationTemplate, ClientConfig } from './types';\nimport { addRenderer } from '../Base';\nimport { ClientRenderer } from './views';\n\n// Client IS is a small information system that:\n// - has a set of purposes that need data from service providers\n// - is able to declare the purpose \n// - tracks consent refs by user and by purpose declaration id. \n// - has UI that allows a user to authenticate\n// - allows to attempt to use the service as authenticated user\n\n\nexport function createClient(name: string, consentService: string, config: ClientConfig[], decls?: PurposeDeclarationTemplate[]): ClientPS {\n    return {\n        type: ClientIS,\n        view: ClientDefaultView,\n        name: name,\n        title: name,\n        mem: {\n            ui: {},\n            db: {\n                consentServiceId: consentService,\n                consentRefByUser: {},\n                purpose: {}\n            },\n            declTemplate: decls,\n            config: config,\n        },\n        queue: []\n    }\n}\n\naddRenderer(ClientIS, ClientDefaultView, ClientRenderer);","import { ConsentServicePS, ConsentServiceDefaultView, ConsentService } from './types'\nimport { addUi, addRenderer } from '../Base';\nimport { ConsentServiceRenderer } from './views';\n\nexport function createConsentService(name: string): ConsentServicePS {\n    return {\n        type: ConsentService,\n        view: ConsentServiceDefaultView,\n        name: name,\n        title: name,\n        mem: {\n            ui: {\n                activePurposeDeclaration: {},\n            },\n            db: {\n                serviceDeclarations: [],\n                purposeDeclarations: [],\n                consents: [],\n                usageLog: [],\n            }\n        },\n        queue: [],\n    };\n}\n\naddRenderer(ConsentService, ConsentServiceDefaultView, ConsentServiceRenderer);\naddUi(ConsentService, '/ui/csui');\n","import { ConsentServicePS, ConsentServiceState } from './types';\nimport { ProcessAndArena } from '../Base';\nimport React from 'react';\nimport { UILink } from '../../components/Process';\nimport { __ } from '../../i18n';\n\nexport interface CSViewProps extends ProcessAndArena<ConsentServiceState> {\n    process: ConsentServicePS;\n}\n\nexport const ConsentServiceRenderer : React.FC<CSViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({process, arena}, ...k);\n\n    const now = (Date.now() / 1000) | 0;\n\n    return (<div>\n        <p>{ process.mem.ui.user !== undefined ? `${t('active-user')} : ${process.mem.ui.user}` : `${t('no-active-user')}.` }</p>\n        <p className=\"small\">\n            { process.mem.db.serviceDeclarations.length } { t('service-declarations')}, <br/>\n            { process.mem.db.purposeDeclarations.length } { t('purpose-declarations')}, <br/>\n            { process.mem.db.consents.filter(c => (!c.revoked && c.validFrom <= now && c.validUntil >= now)).length } { t('active-consents')}, <br/>\n            { process.mem.db.consents.length } { t('total-consents')}\n        </p>\n        <UILink process={process} arena={arena} button={true}> { t('open-end-user-view') }</UILink>\n      </div>);\n}\n\n","import React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\n\nimport { ProcessAndArena } from \"../Base\";\nimport { SimpleSend } from \"../../components/SendButton\";\n\nimport { ServiceProviderState, ServiceProviderPS, ServiceDeclarationTemplate } from \"./types\";\nimport { declareService, addData } from './messages';\nimport { __, business } from \"../../i18n\";\nimport { address2org } from \"../../util\";\n\nexport interface ServiceProviderViewProps extends ProcessAndArena<ServiceProviderState> {\n    process: ServiceProviderPS;\n}\n\nconst updateMaxDuration = (ev: any) => {\n  let f = ev.currentTarget.form!;\n  let v = f[\"consentMaxDurationSeconds\"].value = \n    (f[\"_mdValue\"].value - 0) * (f[\"_mdUnit\"].value) * 24 * 3600;\n  f[\"_mdValue\"].className = \"form-control w-25\" + (v < 1 ? \" is-invalid\" : \"\");\n};\n\nfunction prefillServiceDeclaration(ev: any, decls?: ServiceDeclarationTemplate[]) {\n  ev.preventDefault();\n\n  let declId = ev.currentTarget.value;\n\n  let form = ev.currentTarget.form;\n  let decl = decls!.find(d => d.serviceDeclarationId! === declId);\n  if (decl === undefined) {\n    return;\n  }\n\n  form[\"name\"].value = decl.name;\n  form[\"serviceDeclarationId\"].value = decl.serviceDeclarationId;\n  form[\"technicalDescription\"].value = decl.technicalDescription;\n  form[\"description\"].value = decl.description;\n  form[\"needSignature\"].checked = decl.needSignature === true;\n  let md = decl.consentMaxDurationSeconds || (1 * 365 * 24 * 3600);\n  md = ((md / (24 * 3600)) | 0);\n  if (md > 365) {\n    form[\"_mdValue\"].value = ((md / 365) | 0);\n    form[\"_mdUnit\"].value = 365;\n  } else if (md > 30) {\n    form[\"_mdValue\"].value = ((md / 30) | 0);\n    form[\"_mdUnit\"].value = 30;\n  } else {\n    form[\"_mdValue\"].value = md;\n    form[\"_mdUnit\"].value = 1;\n  }\n\n  updateMaxDuration({ currentTarget: form[\"consentMaxDurationSeconds\"]});\n}\n\nfunction declarationPrefill(sp: ServiceProviderPS) {\n  if (sp.mem.declTemplate === undefined || sp.mem.declTemplate.length === 0) {\n    return <></>;\n  }\n\n  return (\n    <div className=\"form-group\">\n      <label htmlFor=\"prefilled\">Eeltäidetud deklaratsiooni kiirvalik</label>\n      <select className=\"form-control\" id=\"prefilled\" onChange={ ev => prefillServiceDeclaration(ev, sp.mem.declTemplate) } defaultValue=\"\">\n        <option key=\"none\" value=\"\">... vali eeltäidetud deklaratsioon ...</option>\n        {\n          sp.mem.declTemplate.map(dt => (\n            <option key={ dt.serviceDeclarationId } value={ dt.serviceDeclarationId }>{ dt.name! }</option>\n          ))\n        }\n      </select>\n    </div>\n  );\n}\n\nconst DeclareServicePopup : React.FC<ServiceProviderViewProps> = ({process, arena}) => {\n\n    const t = (...k: string[]) => __({process, arena}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n   \n      return (\n        <>\n        <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header closeButton>\n          <Modal.Title>Teenusedeklaratsiooni registreerimine</Modal.Title>\n        </Modal.Header>\n        <form>\n          <Modal.Body>\n              <div className=\"row\">\n                <small className=\"ml-4 mr-4 mb-4 text-center\">\n                  { t('service-decl-intro') }\n                </small>\n              </div>\n              <div className=\"ml-4 mr-4 mb-2 border-bottom\">\n                <h6 className=\"text-center\">{t('declarer')} { business(address2org(process.name), \"name\") } ({ address2org(process.name) })</h6>\n                <input name=\"serviceProviderId\" type=\"hidden\" value={ address2org(process.name) } />\n              </div>\n              <div className=\"row\">\n                <div className=\"col\">\n                  { declarationPrefill(process) }\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdIdentifier\">Teenusedeklaratsiooni identifikaator:</label>\n                    <input name=\"serviceDeclarationId\" type=\"text\" className=\"form-control\" id=\"sdIdentifier\" />\n                    <small id=\"sdIdentifierHelp\" className=\"form-text text-muted\">Andmekogu poolt määratud teenusedeklaratsiooni masinloetav identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdName\">Teenusedeklaratsiooni nimi:</label>\n                    <input name=\"name\" type=\"text\" className=\"form-control\" id=\"sdName\" />\n                    <small id=\"sdNameHelp\" className=\"form-text text-muted\">Teenusedeklaratsiooni identifikaator inimloetaval kujul. Soovitatavalt teenuse kood/nimi ja vajadusel alamteenuse identifikaator.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <div className=\"form-check\">\n                      <input name=\"needSignature\" className=\"form-check-input\" type=\"checkbox\" id=\"signature\" value=\"true|false\"/>\n                      <label className=\"form-check-label\" htmlFor=\"signature\">Vajab digiallkirja?</label>\n                      <small id=\"signatureHelp\" className=\"form-text text-muted\">Märgista see väli, kui andmesubjekt peab selle teenuse andmetele nõusoleku andmisel nõusoleku digitaalselt allkirjastama.</small>\n                    </div>\n                  </div>\n                </div>\n                <div className=\"col\">\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdTechDescription\">Teenuse tehniline kirjeldus:</label>\n                    <textarea name=\"technicalDescription\" className=\"form-control\" id=\"sdTechDescription\" rows={5} />\n                    <small id=\"sdTechDescriptionHelp\" className=\"form-text text-muted\">Teenuse ja selle osutamise tehniline kirjeldus. Kasutamiseks klientsüsteemide haldajatele</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <label htmlFor=\"sdDescription\">Teenuse andmekoosseisu kirjeldus:</label>\n                    <textarea name=\"description\" className=\"form-control\" id=\"sdDescription\" rows={5}/>\n                    <small id=\"sdDescriptionHelp\" className=\"form-text text-muted\">Teenuse inimloetav kirjeldus. Tagastatavad andmed, teenuse sisu jne. Kuvatakse nõusoleku andmisel andmesubjektile.</small>\n                  </div>\n                  <div className=\"form-group\">\n                    <input type=\"hidden\" name=\"consentMaxDurationSeconds\" value={1 * 365 * 24 * 3600 }/>\n                    <label htmlFor=\"maxDuration\">Nõusoleku maksimaalne kehtivusaeg:</label>\n                    <div className=\"form-inline\">\n                    <input type=\"number\" size={3} className=\"form-control w-25\" id=\"maxDuration\" name=\"_mdValue\" onChange={updateMaxDuration} defaultValue={1}/>\n                    <select name=\"_mdUnit\" className=\"form-control input-group-append\" onChange={updateMaxDuration}>\n                      <option value={ 365 }>{ t('year') }</option>\n                      <option value={  30 }>{ t('month') }</option>\n                      <option value={   1 }>{ t('day') }</option>\n                    </select>\n                    </div>\n                  </div>\n                </div>\n              </div>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>{ t('close')}</Button>\n            <SimpleSend arena={arena} owner={process} onClick={() => handleClose()} text={ t('declare') } message={ declareService() }/>\n          </Modal.Footer>\n        </form>\n      </Modal>\n      <Button variant=\"dark\" onClick={handleShow}>\n        {t('declare')}\n      </Button>\n\n         </>\n      )\n  }\n  \n\nexport const ServiceProviderRenderer : React.FC<ServiceProviderViewProps> = ({process, arena}) => {\n    const t = (...k: string[]) => __({process, arena}, ...k);\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n    const allValues : string[] = (() => {\n      let values = process.mem.services.map(s => s.returnedDatatypes).flat().concat(process.mem.db.map(r => r.type));\n      values.sort();\n      let out : string[] = [];\n      values.forEach((v) => { if (out.length === 0 || v !== out[out.length - 1]) out.push(v); });\n      return out;\n    })();\n    return (<div>\n        <p className=\"small\">\n          {/* process.mem.services.length } { t('services-defined') }<br/> //FIXME: Confusing for demo audience?*/ }\n          { process.mem.db.length } <button className=\"btn-link\" onClick={handleShow}>{ t('records-in-db') }</button>\n        </p>\n        <Modal show={show} onHide={handleClose} size=\"lg\">\n          <Modal.Header>\n            <Modal.Title>{ t('database') }: { t('title') }</Modal.Title>\n          </Modal.Header>\n          <Modal.Body>\n            <form>\n                <table className=\"table\">\n                    <thead>\n                        <tr>\n                            <th className=\"border-top-0\">id</th>\n                            <th className=\"border-top-0\">type</th>\n                            <th className=\"border-top-0\">subject</th>\n                            <th className=\"border-top-0\">data</th>\n                            <th className=\"border-top-0\"></th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                    { \n                        process.mem.db.map(r => (\n                            <tr key={ r.key }>\n                                <td>{ r.key }</td>\n                                <td>{ r.type }</td>\n                                <td>{ r.subject }</td>\n                                <td>{ JSON.stringify(r.data, undefined, \" \") }</td>\n                                <td>\n                                    <SimpleSend arena={arena} owner={process} text=\"-\" message={\n                                        addData({ key: r.key, datatype: undefined, subject: undefined, data: undefined })\n                                    }/>\n                                </td>\n                            </tr>\n                        ))\n                    }\n                    <tr key=\"add\">\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"key\" defaultValue={ (Math.random() * 10000) | 0 }/></td>\n                        <td><input className=\"form-control\" type=\"text\" size={8} name=\"datatype\" \n                            defaultValue={ allValues.length > 0 ? allValues[0] : \"\" } /></td>\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"subject\"/></td>\n                        <td><input className=\"form-control\" type=\"text\" size={10} name=\"data\"/></td>\n                        <td><SimpleSend arena={arena} owner={process} text=\"+\" message={addData()} onClick={(ev) => {\n                            let f = ev.currentTarget.form;\n                            f.key.value = (Math.random() * 10000) | 0;\n                            f.datatype.value = \"\";\n                            f.subject.value = \"\";\n                            f.data.value = \"\";\n                        }} /></td>\n                    </tr>\n                    </tbody>\n                </table>\n            </form>\n          </Modal.Body>\n          <Modal.Footer>\n            <Button variant=\"secondary\" onClick={handleClose}>{ t('close') }</Button>\n          </Modal.Footer>\n        </Modal>\n        <DeclareServicePopup arena={arena} process={process}/>\n      </div>);\n}\n\n","import { ServiceConfig, ServiceProviderPS, ServiceProviderDefaultView, ServiceProviderIS, SecretRecord, ServiceDeclarationTemplate } from \"./types\";\nimport { addRenderer } from \"../Base\";\nimport { ServiceProviderRenderer } from \"./views\";\n\n\nexport function createServiceProvider(name: string, title: string, config: ServiceConfig[], db?: SecretRecord[], decls?: ServiceDeclarationTemplate[]): ServiceProviderPS {\n    return {\n        type: ServiceProviderIS,\n        view: ServiceProviderDefaultView,\n        name: name,\n        title: title,\n        mem: {\n            db: db === undefined ? [] : db,\n            services: config,\n            inflight: [],\n            declTemplate: decls,\n        },\n        queue: []\n    };\n}\n\naddRenderer(ServiceProviderIS, ServiceProviderDefaultView, ServiceProviderRenderer);\n","import { createCounter } from \"./process/Counter\";\nimport { createTokenNode } from \"./process/TokenRing\";\nimport { ProcessState } from \"./process/Base\";\nimport { createArena } from \"./components/Arena\";\nimport { fromArray } from \"./byNameStore\";\nimport { TheatreState } from \"./components/Theatre\";\nimport { createClient } from \"./process/client/constructor\";\nimport { createConsentService } from \"./process/consentService/constructor\";\nimport { createServiceProvider } from \"./process/serviceProvider/constructor\";\nimport { SecretRecord } from \"./process/serviceProvider/types\";\nimport { LogRendererMap, consentRefApiLogRenderers, addLogRenderers } from \"./components/LogRows\";\n\n// initial configuration\n\ntype ConfigType = { \n    defaultArena: string;\n    arenas: { [name: string]: { processes: ProcessState<any>[]; logRenderers?: LogRendererMap }; }\n};\n\n\nconst CS1Address = \"EE/GOV/70009770/nt\";\n\nconst config : ConfigType = {\n    defaultArena: \"demo\",\n    // arenas: arena -> [process]\n    arenas: {\n        \"demo\": {\n            processes: [\n                createClient(\"EE/COM/10112345/healthstartup\", CS1Address, [ // client configuration\n                    { // vaktsineerimise meeldetuletused\n                        purposeDeclarationId: \"tervisepaevik_vaktsineerimised\",\n                        services: [\n                            {\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.282\",\n                            }\n                        ]\n                    },\n                    { // terviseandmete visualiseerimine\n                        purposeDeclarationId: \"tervisepaevik_visualiseerimine\",\n                        services: [\n                            { // diagnoosid\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.32\",\n                            },\n                            { // uuringud\n                                serviceAddress: \"EE/GOV/70009770/digilugu\",\n                                serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.35\",\n                            }\n                        ]\n                    }\n                ], [ // prefilled service declaration templates\n                    {\n                        purposeDeclarationId: \"tervisepaevik_visualiseerimine\",\n                        name: \"Terviseandmete visualiseerimine\",\n                        description: \"HealthStartup diagnooside ja uuringute tulemuste visualiseerimist pakkuv teenus.\\n\\n\" +\n                            \"Nõusoleku tagasivõtmisel kustutab HealthStartup kõik Sinu kohta saadud andmed.\",\n                        services: [\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_diagnoosid\" },\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_uuringud\" }\n                        ]\n                    },\n                    {\n                        purposeDeclarationId: \"tervisepaevik_vaktsineerimised\",\n                        name: \"Vaktsineerimiste meeldetuletused\",\n                        description: \"HealthStartup vaktsineerimiste meeldetuletusi ja immuniseerimisplaani pakkuv teenus.\\n\\n\" +\n                           \"Nõusoleku tagasivõtmisel kustutab HealthStartup kõik Sinu kohta saadud andmed.\",\n                        services: [\n                            { serviceProviderId: \"EE/GOV/70009770\", serviceDeclarationId: \"hl7_immuniseerimispass\" }\n                        ]\n                    }\n                ]),\n            \n                createServiceProvider(\"EE/GOV/70009770/digilugu\", \"Tervise Infosüsteem\", [ // services\n                    { // immuniseerimispassi teenus\n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.282\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_immuniseerimispass\" ],\n                        returnedDatatypes: [ \"immuniseerimine\" ]\n                    },\n                    { // uuringute päringu teenus\n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.35\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_uuringud\" ],\n                        returnedDatatypes: [ \"uuring\" ]\n                    },\n                    { // \n                        serviceName: \"hl7!1.3.6.1.4.1.28284.6.1.1.32\",\n                        consentService: CS1Address,\n                        requiredServiceDeclarationIds: [ \"hl7_diagnoosid\" ],\n                        returnedDatatypes: [ \"diagnoos\" ],\n                    }\n                ], [ // secret data\n                    createData(\"01234567890\", \"diagnoos\", { diagnoos: \"A01\", arst: \"D03677\" }),\n                    createData(\"12345678901\", \"diagnoos\", { diagnoos: \"J01\", arst: \"D08031\"}),\n                    createData(\"47302200234\", \"diagnoos\", { diagnoos: \"J00\", arst: \"D05076\" }),\n                    createData(\"47302200234\", \"uuring\", { uuring: \"uuring 1\", arst: \"D12345\", vastus: \"korras.\" }),\n                    createData(\"47302200234\", \"immuniseerimine\", { \n                        haigus: \"A-gripp\", preparaat: \"Vaxigriptetra\", seeria:\"A2321-3232\", jrk: 3, uuesti: \"2020-10-22\"\n                    }),\n                ], [ // prefilled service declaration templates\n                    {\n                        serviceDeclarationId: \"hl7_uuringud\",\n                        name: \"Uuringute päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.35\",\n                        description: \"Andmekogule saadetakse päringu parameetrina Sinu isikukood.\\n\\n\" +\n                            \"Andmekogust Tervise Infosüsteem saadakse iga Sinu uuringu kohta järgmised andmed:\\n\" +\n                            \"  * Sinu andmed: nimi ja isikukood:\\n\" +\n                            \"  * Uuringu andmed:\\n\" +\n                            \"    * Uuringu tegemise aeg ja koht (raviasutus)\\n\" +\n                            \"    * Proovimaterjali tüüp\\n\" +\n                            \"    * Uuringu tüüp\\n\" +\n                            \"    * Uuringu vastus\\n\" +\n                            \"  * Uuringu teostanud tervishoiutöötaja andmed: nimi, kood ja tervishoiuasutuse andmed\",\n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    {\n                        serviceDeclarationId: \"hl7_diagnoosid\",\n                        name: \"Diagnooside päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.32\",\n                        description: \"Andmekogust Tervise Infosüsteem saadakse iga Sinu diagnoosi kohta järgmised andmed:\\n\" +\n                            \"  * Sinu andmed: nimi ja isikukood\\n\" +\n                            \"  * Haigusjuhtumi andmed: diagnoosi andmise aeg, diagnoos\\n\" +\n                            \"  * Diagnoosi andnud tervishoiutöötaja andmed: nimi, kood ja tervishoiuasutuse andmed\",\n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    {\n                        serviceDeclarationId: \"hl7_immuniseerimispass\",\n                        name: \"Immuniseerimispassi päring\",\n                        technicalDescription: \"X-tee teenuse 'hl7' päring, HL7 OID: 1.3.6.1.4.1.28284.6.1.1.282\",\n                        description: \"Andmekogust Tervise Infosüsteem saadakse iga Sinu immuniseerimise kohta järgmised andmed:\\n\" +\n                        \"  * Sinu andmed: nimi ja isikukood\\n\" +\n                        \"  * Immuniseerimise andmed:\\n\" +\n                        \"    * Haigus mille vastu immuniseeriti\\n\" +\n                        \"    * Immuniseerimise kuupäev\\n\" +\n                        \"    * Immuunpreparaadi nimi, partii number ja manustatud annus\\n\" +\n                        \"    * Mitmes annus\\n\" +\n                        \"    * Järgmine immuniseerimise varaseim kuupäev\\n\" +\n                        \"  * Immuniseerija andmed: nimi, kood ja tervishoiuasutuse andmed\", \n                        needSignature: true,\n                        consentMaxDurationSeconds: 5 * 365 * 24 * 3600,\n                    },\n                    \n                ]),\n\n                createConsentService(\"EE/GOV/70009770/nt\"),\n            ],\n            logRenderers: {\n                ...consentRefApiLogRenderers\n            },\n        },\n\n\n        \"singleCounter\": { processes: [\n          createCounter(\"counter1\"),\n        ]},\n\n        \"tokenRing\": { processes: [\n          createTokenNode(\"sd.title\", \"a\", \"b\"),\n          createTokenNode(\"pd.title\", \"b\", \"c\"),\n          createTokenNode(\"ca.title\", \"c\", \"c\"),\n        ]}\n    }\n};\n\nexport function createData(subjectId: string, type: string, data: any): SecretRecord {\n    return {\n        key: \"\" + ((Math.random() * 10000) | 0),\n        type: type,\n        subject: subjectId,\n        data: data\n    };\n}\n\n\n\nexport function initialTheatre(): TheatreState {\n    return {\n        name: \"theatre\",\n        arenas: fromArray(Object.keys(config.arenas).map(a => createArena(a, config.arenas[a].processes))),\n        active: config.defaultArena,\n    }\n}\n\nObject.keys(config.arenas).forEach(arena => {\n    if (config.arenas[arena].logRenderers !== undefined) {\n        addLogRenderers(arena, config.arenas[arena].logRenderers!);\n    }\n})\n","import React from 'react';\nimport { connect } from 'react-redux';\n\nimport { ArenaState, Arena, reduceArena, ArenaActionType } from './Arena';\nimport { AppState } from '../store';\nimport { ByNameStore, reduceByName } from '../byNameStore';\nimport { initialTheatre } from '../config';\nimport { AnyAction } from 'redux';\n\ntype Arenas = ByNameStore<ArenaState>;\n\nexport interface TheatreState {\n    name: string;\n    arenas: Arenas;\n    active: string;\n}\n\nexport function selectArena(state: AppState, arena: string) {\n    return state.theatre.arenas.byName[arena];\n}\n\nconst SELECT_ARENA = \"Theatre/SELECT_ARENA\";\ninterface SelectArenaAction extends AnyAction {\n    type: typeof SELECT_ARENA;\n    arena: string;\n}\n\n// function selectArenaMessage(arena: string): SelectArenaAction {\n//     return { type: SELECT_ARENA, arena: arena };\n// }\n\nexport function reduceTheatre(state: TheatreState = initialTheatre(), action: any): TheatreState {\n    switch (action.type) {\n        case SELECT_ARENA:\n            return ({ ...state, active: action.arena });\n        default:\n            return ({ ...state, arenas: reduceByName(state.arenas, (a) => reduceArena(a, action as ArenaActionType)) });\n        }\n}\n\ninterface TheatreProps {\n    theatre: TheatreState;\n}\n\nclass _Theatre extends React.PureComponent<TheatreProps> {\n    // <ArenaSelector arenaNames={ this.props.theatre.arenas.allNames }/>\n    componentDidMount() {\n        require('../App.css');\n        require('../bootstrap.css');\n    }\n\n    render() {\n        return (\n            <div>\n                <Arena arena={ this.props.theatre.arenas.byName[this.props.theatre.active] }/>\n            </div>\n\n        )\n    }\n}\n\nexport const Theatre = connect(mapStateToProps)(_Theatre);\n\nfunction mapStateToProps(state: AppState) {\n    return { theatre: state.theatre }\n}\n\n\n// interface ArenaSelectorProps {\n//     arenaNames: string[];\n//     selectArenaMessage: (arena: string) => void; \n// }\n\n// class ArenaSelectorComponent extends React.PureComponent<ArenaSelectorProps> {\n//     render() {\n//         return (\n//             <select onChange={(ev) => this.props.selectArenaMessage(ev.currentTarget.value)}>\n//                 { this.props.arenaNames.map(n => (<option value={n} key={n}>{n}</option>))}\n//             </select>\n//         );\n//     }\n// }\n\n// const ArenaSelector = connect(undefined, { selectArenaMessage })(ArenaSelectorComponent);\n","import { BackendAPI } from \"../../../postMessage\";\nimport { ConsentServiceState, PurposeDeclaration, Consent, UsageRecord, PurposeDeclarationRef, findFrom, ServiceDeclarationRef, ServiceDeclaration } from \"../types\";\nimport React, { useContext } from \"react\";\nimport { loginMessage, giveConsentMessage, revokeConsentMessage, activatePurposeDeclarationMessage } from \"../ui\";\nimport { hash } from \"../../../util\";\nimport { fixRevoked } from \"../referenceAPI\";\n\nexport class ConsentServiceBackend extends BackendAPI<ConsentServiceState> {\n    login(ev:any, user?: string) {\n        console.log(\"login(\", user, \")\");\n        ev.preventDefault();\n        this.post(loginMessage({ user }));\n    }\n\n    giveConsentByPurpose(ev: any, services : ServiceDeclarationRef[], clientId: string, purposeDeclarationId: string) {\n        console.log(`giveConsent(${clientId}, ${purposeDeclarationId})`);\n        ev.preventDefault();\n        const expiresIn = services.map( s => this.getServiceDeclaration(s)!.consentMaxDurationSeconds).sort()[0];\n        this.post(giveConsentMessage({\n            dataSubject: this.mem!.ui.user,\n            clientId: clientId,\n            purposeDeclarationId: purposeDeclarationId,\n            validFrom: (Date.now() / 1000) | 0,\n            validUntil: this.getValidUntil(services),\n            revoked: false,\n            // for technical reasons, we issue consentReference here. \n            // in real system it happens in (real) backend. \n            consentReference: hash(clientId + purposeDeclarationId + Date.now())\n        }))\n    }\n\n    revokeConsent(ev: any, consentReference: string) {\n        console.log(`revokeConsent(${consentReference})`);\n        ev.preventDefault();\n        this.post(revokeConsentMessage({ consentReference, revokeAt : Math.floor(Date.now()/1000) }))\n    }\n\n    // parameetrita/valid === undefined -> k]ik aktiivse kasutaja konsendid\n    // parameetriga -> ainult need, mis kas kehtivad v]i mitte\n    getConsents(valid?: boolean): Consent[] {\n        if (this.mem === undefined) {\n            return [];\n        }\n\n        let now = (Date.now() / 1000) | 0;\n        let user = this.mem.ui.user!;\n\n        return (this.mem.db.consents\n            .map(fixRevoked(now))\n            .filter(\n                c => (c.dataSubject === user \n                    && (valid === undefined \n                        || (valid === (c.validFrom <= now && c.validUntil >= now && !c.revoked)))) \n        ));\n    }\n\n    // need asjad kõlbavad consendi andmiseks FIXME seda vist pole enam vaja\n    getPDsWithoutValidConsent(): PurposeDeclaration[] {\n        if (this.mem === undefined) {\n            console.error(\"Not connected? No local state yet\");\n            return [];\n        }\n\n        let consents = this.getConsents(true);\n\n        return this.mem!.db.purposeDeclarations.filter(\n            pd => consents.find(c => (c.clientId === pd.clientId && c.purposeDeclarationId === pd.purposeDeclarationId)) === undefined\n        );\n    }\n\n    getUsageLogRecords(): UsageRecord[] {\n        if (this.mem === undefined) {\n            return [];\n        }\n\n        return this.mem.db.usageLog.filter(ur => ur.subjectId === this.mem!.ui.user);\n    }\n\n    activatePurposeDeclaration(ev: any, ref: PurposeDeclarationRef) {\n        ev.preventDefault();\n        if (this.mem === undefined) {\n            return;\n        }\n\n        this.post(activatePurposeDeclarationMessage(ref));\n    }\n\n    getActivePurposeDeclaration(): PurposeDeclaration | undefined {\n        if (this.mem === undefined || this.mem.ui.activePurposeDeclaration === undefined || this.mem.ui.activePurposeDeclaration[this.mem.ui.user!] === undefined) {\n            return undefined;\n        }\n\n        let candidate = findFrom(\n            this.mem.db.purposeDeclarations,\n            { ...this.mem.ui.activePurposeDeclaration[this.mem.ui.user!], callbackURL: undefined } as PurposeDeclarationRef\n        );\n\n        if (candidate === undefined || \n            findFrom(this.getConsents(true), { // if there is a valid consent for that candidate\n                clientId: candidate.clientId,\n                purposeDeclarationId: candidate.purposeDeclarationId\n            }) !== undefined) {\n\n            return undefined;\n        }\n        return {...candidate, validUntil: this.getValidUntil(this.mem.db.serviceDeclarations)};\n    }\n\n    getServiceDeclaration(ref: ServiceDeclarationRef): ServiceDeclaration | undefined {\n        if (this.mem === undefined) {\n            return undefined;\n        }\n\n        return findFrom(this.mem.db.serviceDeclarations, ref);\n    }\n\n    getPurposeDeclaration(ref: PurposeDeclarationRef): PurposeDeclaration | undefined {\n        if (this.mem === undefined) {\n            return undefined;\n        }\n\n        return findFrom(this.mem.db.purposeDeclarations, ref);\n    }\n\n    getValidUntil(services : ServiceDeclarationRef[]) {\n        const expiresIn = services.map( s => this.getServiceDeclaration(s)!.consentMaxDurationSeconds).sort()[0];\n        return Number(Math.floor(Date.now() / 1000)) + Number(expiresIn)\n    }\n}\n\nexport const CSBackend = React.createContext(undefined as (ConsentServiceBackend | undefined));\n\nexport class Backend {\n  use() {\n    const ctx = useContext(CSBackend);\n    return (ctx === undefined || ctx === null) ? ctx : new ConsentServiceBackend(ctx);\n  }\n}\n","import * as React from 'react';\n\n// <div className=\"footer-logo\">\n//   <img className=\"logo-brand\" alt=\"logo\" src={require('./../../static/assets/images/logo-est.png')} />\n// </div>\nconst Footer = () => {\n  return(\n    <footer>\n      <div className=\"footer-top\">\n\n        <div className=\"footer-contact\">\n          <div>\n            <div className=\"footer-contact-icon\">\n              <i className=\"icon-phone\"></i>\n            </div>\n          </div>\n          <div className=\"footer-contact-text\">\n            <table>\n              <tbody>\n                <tr>\n                  <th><a className=\"link-phone\" href=\"tel:+372-555-1\">555 1234</a></th>\n                  <th>Üldinfo</th>\n                </tr>\n                <tr>\n                  <td><a className=\"link-phone\" href=\"tel:+372-555-1234\">555 1234</a></td>\n                  <td>Teine osakond</td>\n                </tr>\n                <tr>\n                  <td><a className=\"link-phone\" href=\"tel:+372-555-1234\">555 1234</a></td>\n                  <td>Kolmas osakond</td>\n                </tr>\n              </tbody>\n            </table>\n            <a className=\"link-orange\" href=\"http://www.digilugu.ee/\" target=\"_blank\" rel=\"noopener noreferrer\">Kõik kontaktandmed</a>\n          </div>\n        </div>\n      </div>\n    </footer>\n  )\n}\n\nexport default Footer;","import * as React from 'react';\nimport { fullname } from '../../i18n';\n\nconst Header = ({backend}: any) => {\n  let backendUse = backend.use();\n  return(\n    <>\n    <nav className=\"navbar\">\n      <ul className=\"navbar-nav desktop-nav\">\n        <li className=\"nav-item with-logo\">\n          <img className=\"logo-brand\" alt=\"logo\" width=\"170\" src={require('./../../static/assets/images/logo-est.png')} />\n        </li>\n        {backendUse && backendUse.mem.ui.user &&\n          <li className=\"nav-item with-title\">\n            <p className=\"nav-item-title\">Kasutaja</p>\n            <p>{ fullname(backendUse.mem.ui.user) }</p>\n          </li>\n        }\n        {backendUse && backendUse.mem.ui.user &&\n          <li className=\"nav-item nav-logout\">\n            <button className=\"btn btn-logout\" onClick={(ev) => backendUse.login(ev)}>Väljun</button>\n          </li>\n        }\n      </ul>\n    </nav>\n    </>\n  )\n}\n\nexport default Header;","import React from 'react';\nimport Footer from './footer';\nimport Header from './header';\n\nconst VeeraLayout = ({children, backend}: any) => {\n  let backendUse = backend.use();\n  return (\n    <div className={\"wrapper \" + (backendUse && backendUse.mem.ui.user ? 'push' : '')}>\n      { backendUse && backendUse.mem.ui.user &&\n        <Header backend={backend} />\n      }\n      <div className=\"content-wrapper\">\n      <div className=\"workarea\">\n        {children}\n      </div>\n      </div>\n      <Footer />\n    </div>\n  );\n}\nexport default VeeraLayout;","import React from 'react';\nimport PropTypes from 'prop-types';\n\ninterface Props {\n  activeTab: string;\n  label: string;\n  onClick: (tab: string) => void;\n}\n\nexport class Tab extends React.Component<Props, {}> {\n  static propTypes = {\n    activeTab: PropTypes.string.isRequired,\n    label: PropTypes.string.isRequired,\n    onClick: PropTypes.func.isRequired,\n  };\n\n  onClick = () => {\n    const { label, onClick } = this.props;\n    onClick(label);\n  }\n\n  render() {\n    const {\n      onClick,\n      props: {\n        activeTab,\n        label,\n      },\n    } = this;\n\n    let className = 'sidebar-item';\n\n    if (activeTab === label) {\n      className += ' active';\n    }\n\n    return (\n      <li\n        className={className}\n        onClick={onClick}\n        style={{cursor: 'pointer'}}\n      >\n        {label}\n      </li>\n    );\n  }\n}\n\nexport default Tab;","import React from 'react';\nimport PropTypes from 'prop-types';\nimport Tab from './Tab';\n\ninterface Props {\n  children: React.ReactElement<any>[];\n}\n\ninterface State {\n  activeTab: string;\n}\n\ndeclare module 'react' {\n  interface HTMLAttributes<T> extends AriaAttributes, DOMAttributes<T> {\n    // extends React's HTMLAttributes\n    label?: string;\n  }\n}\n\nclass Tabs extends React.Component<Props, State> {\n  static propTypes = {\n    children: PropTypes.instanceOf(Array).isRequired,\n  }\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      activeTab: this.props.children[0].props.label,\n    };\n  }\n\n  onClickTabItem = (tab: string) => {\n    this.setState({ activeTab: tab });\n  }\n\n  render() {\n    const {\n      onClickTabItem,\n      props: {\n        children,\n      },\n      state: {\n        activeTab,\n      }\n    } = this;\n\n    return (\n      <div>\n        <div id=\"sidebar\">\n          <ol>\n            {children.filter(c => c.props.label !== undefined).map((child) => {\n              const { label } = child.props;\n\n              return (\n                <Tab\n                  activeTab={activeTab}\n                  key={label}\n                  label={label}\n                  onClick={onClickTabItem}\n                />\n              );\n            })}\n          </ol>\n        </div>\n        <div className=\"section\">\n          {children.map((child) => {\n            if (child.props.label !== activeTab) return undefined;\n            return child.props.children;\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default Tabs;","import { ConsentServiceBackend } from \"./backendAPI\";\nimport { Consent } from \"../types\";\nimport React from \"react\";\nimport { Modal, Button } from \"react-bootstrap\";\nimport { formatTimestamp } from \"./CSEnduserUI\";\nimport { isConsentActive } from \"./MyConsents\";\nimport { business } from \"../../../i18n\";\nimport { renderText } from \"../../../util\";\n\nexport const ConsentModal: React.FC<{backend: ConsentServiceBackend, consent: Consent, buttonText : string}> = ({backend, consent, buttonText}) => {\n\n    const [show, setShow] = React.useState(false);\n    const handleClose = () => setShow(false);\n    const handleShow = () => setShow(true);\n\n    const handleRevoke = (ev:any) => {\n      setShow(false);\n      backend.revokeConsent(ev, consent.consentReference);\n    }\n\n    if (backend.mem === undefined) {\n        return null;\n      }\n      const dec = backend.mem.db.purposeDeclarations.find(p => p.purposeDeclarationId === consent.purposeDeclarationId);\n      if (dec === undefined) {\n        return null;\n      }\n\n      const rowView = (name: string, value: any, last?: boolean) => {\n        return (\n          <div className=\"row\" key={name}>\n            <div className=\"col-md\">\n              <div className= { last ? \"d-flex align-items-end\" : \"d-flex align-items-baseline\" }>\n                <div><h4> { name }</h4></div>\n                <div>{ value }</div>\n              </div>\n              </div>\n          </div>\n        )\n      }\n\n    const Body = () => {\n      let services = dec.services.map(sdref => {\n        const sd = backend.getServiceDeclaration(sdref);\n        if (sd === undefined) {\n          return <></>;\n        }\n        return (\n          <>\n            <h4>{sd.name}</h4>\n            { renderText(sd.description) }\n          </>\n        )\n      })\n      return (\n        <div className=\"tab-info\">\n          { rowView('Nõusoleku saaja:', `${business(dec.clientId, \"name\")} (${business(dec.clientId, \"ntr\")})`) }\n          { rowView('Rakendus:', `${ business(dec.clientId, \"appname\") }` ) }\n          { rowView('Nõusolek antud:', formatTimestamp(consent.validFrom)) }\n          { isConsentActive(consent)\n              ? rowView('Nõusolek kehtib kuni:', formatTimestamp(consent.validUntil))\n              : rowView('Nõusolek tühistatud:', formatTimestamp(consent.validUntil)) }\n          { rowView('Eesmärk:', renderText(dec.description), true) }\n          { rowView(`Nõusoleku alusel saab ${business(dec.clientId, \"name\")} Sinu kohta järgmised andmed:`, services, true)}\n        </div>\n      )\n    }\n\n    return (\n    <>\n      <Modal show={show} onHide={handleClose} size=\"lg\">\n        <Modal.Header>\n          <Modal.Title>Detailid</Modal.Title>\n        </Modal.Header>\n        <Modal.Body>\n          <Body />\n        </Modal.Body>\n        <Modal.Footer>\n          { isConsentActive(consent) &&\n          <Button variant=\"primary\" onClick={(ev:any) => handleRevoke(ev)}>\n            Võtan nõusoleku tagasi\n          </Button>\n          }\n          <Button variant=\"secondary\" onClick={handleClose}>\n            Sule\n          </Button>\n        </Modal.Footer>\n      </Modal>\n      <Button variant=\"primary\" onClick={handleShow}>\n        { buttonText }\n      </Button>\n    </>\n    )\n};","import { ConsentServiceBackend } from './backendAPI';\nimport React from 'react';\nimport { Consent } from '../types';\nimport { formatTimestamp } from './CSEnduserUI';\nimport { ConsentModal } from './ConsentModal';\nimport { business } from '../../../i18n';\n\nexport function isConsentActive(consent : Consent) {\n  return !consent.revoked && consent.validUntil > Date.now()/1000;\n}\n\nfunction consentDescription(c : Consent) {\n  return (\n    `${business(c.clientId, \"name\")}; ${business(c.clientId, \"appname\")}; Nõusolek antud ${formatTimestamp(c.validFrom)}` +\n    ` – ${ c.revoked ? \"nõusolek tühistatud\" : \"kehtib kuni\" } ${formatTimestamp(c.validUntil)}`\n  );\n}\n\nexport const MyConsents = (backend :  ConsentServiceBackend) => {\n\n  const Table = (consents : Consent[], header : JSX.Element) => {\n    return (\n      <>\n        <h4>{ header }</h4>\n        <table className=\"table align-middle\">\n          <tbody>\n            { consents.map( c => (\n              <tr key={c.clientId}>\n                <td>{ consentDescription(c) }</td>\n                <td><ConsentModal backend={backend} consent={c} buttonText=\"Vaata lähemalt\"/></td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </>\n    )\n  }\n\n  const Body = (backend : ConsentServiceBackend) => {\n\n    if (backend.getConsents().length === 0) {\n      return (\n        <p>Nõusolekuid ei leitud.</p>\n      )\n    }\n\n    const header = (title: string, length: number) => (\n      <h4>\n        <span>{title}</span>\n        {length === 0 &&\n          <span className=\"badge badge-default ml-2\">\n            <span className=\"badge-text\">Puuduvad</span>\n          </span>\n        }\n      </h4>\n    )\n\n    return (\n      <>\n        { Table( backend.getConsents(true),  header(\"Kehtivad nõusolekud:\", backend.getConsents(true).length)) }\n        { Table( backend.getConsents(false), header(\"Kehtetud nõusolekud:\", backend.getConsents(false).length)) }\n      </>\n    )\n  }\n\n  return (\n    <div label = \"Minu nõusolekud\"> { Body(backend) } </div>\n  )\n}\n","import { ConsentServiceBackend } from './backendAPI';\nimport { UsageRecord } from '../types';\nimport React from 'react';\nimport { formatTimestamp } from './CSEnduserUI';\nimport { ConsentModal } from './ConsentModal';\nimport { business } from '../../../i18n';\n\nfunction usageRecordDescription(u: UsageRecord) {\n  if (u.result === 'OK') {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' sai Sinu andmed nõusoleku alusel';\n  } else if (u.consentReference) {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' küsis, kuid ei saanud Sinu andmeid tühistatud nõusoleku alusel';\n  } else {\n    return formatTimestamp(u.usageTime, true) + ' ' + business(u.clientId, \"name\") + ' küsis, kuid ei saanud Sinu andmeid nõusoleku puudumise tõttu';\n  }\n} \n\nexport const ConsentHistory = (backend : ConsentServiceBackend) => {\n\n  const Modal = (backend : ConsentServiceBackend, consentReference : string) => {\n    if (!backend.mem) {\n      return;\n    }\n    const con = backend.mem.db.consents.find(c => c.consentReference === consentReference);\n    if (!con) {\n      return;\n    }\n    return (<td><ConsentModal backend={backend} consent={con} buttonText=\"Vaata nõusolekut\"/></td>)\n  }\n\n  const Body = (backend : ConsentServiceBackend) => {\n    if (backend.getUsageLogRecords().length === 0) {\n      return (\n        <p>Nõusolekute kasutamise sündmusi ei leitud.</p>\n      )\n    }\n    return (\n      <>\n        <h4>Ajalugu:</h4>\n        <table className=\"table align-middle\">\n          <tbody>\n          {\n            backend.getUsageLogRecords().map(\n              u => (\n                <tr key={u.clientId}>\n                  <td>{ usageRecordDescription(u) }</td>\n                  { u.consentReference ? Modal(backend, u.consentReference) : (<></>) }\n                </tr>\n              )\n            )\n          }\n          </tbody>\n        </table>\n      </>\n    )\n  } \n\n  return (\n    <div label=\"Nõusolekute kasutamise ajalugu\">\n      { Body(backend) }\n    </div>\n  );\n};\n","import React from 'react';\nimport { BackendStateUpdater } from '../../../postMessage';\nimport { ConsentServiceState, PurposeDeclaration } from '../types';\nimport { ConsentServiceBackend, Backend, CSBackend } from './backendAPI';\nimport VeeraLayout from './../../../components/veera/layout';\nimport Tabs from './../../../components/tabs/Tabs';\nimport { MyConsents } from './MyConsents';\nimport { ConsentHistory } from './ConsentHistory';\nimport { business } from '../../../i18n';\nimport { renderText } from '../../../util';\nimport { Modal, Button } from \"react-bootstrap\";\n\n\nfunction LoginScreen() {\n  return (\n    <div className=\"section\">\n      <h4>Nõusoleku andmiseks sisene Tervise- ja Heaolu Infosüsteemide Keskuse nõusolekute andmise keskkonda:</h4>\n      <p className=\"mt-3\"><a href=\"/ui/ria\" className=\"btn btn-primary\">Sisene</a></p>\n    </div>\n  );\n}\n\ninterface APDProps {\n  backend: ConsentServiceBackend;\n  activeDecl?: PurposeDeclaration;\n  tabRef: React.RefObject<Tabs>;\n  label: string;\n}\n\ninterface State {\n  signPopup: boolean;\n  returnPopup: boolean;\n  savedClientId?: string;  \n}\n\nclass ActivePurposeDeclaration extends React.PureComponent<APDProps, State> {\n  state : State = {\n    signPopup: false,\n    returnPopup: false,\n  };\n\n  constructor(props: APDProps) {\n    super(props);\n    this.showConsentTab = this.showConsentTab.bind(this);\n  }\n\n  showSignPopup(show: boolean) {\n    this.setState(s => ({ ...s, signPopup: show }));\n  }\n\n  showReturnPopup(show = true, clientId?: string) {\n    this.setState(s => ({ ...s, returnPopup: show, savedClientId: clientId }))\n  }\n\n  toggleSignPopup() {\n    this.setState(s => ({ ...s, signPopup: !s.signPopup }))\n  }\n\n  showConsentTab(ev: any) {\n    ev.preventDefault();\n    if (this.props.tabRef.current) this.props.tabRef.current.onClickTabItem(\"Minu nõusolekud\");\n  };\n\n  Popover() {\n    return (\n      <>\n        <Modal show={this.state.signPopup} onHide={() => this.toggleSignPopup()}>\n          <Modal.Body>\n            <h4>Nõusoleku andmiseks allkirjasta nõusolek digitaalselt</h4>\n          </Modal.Body>\n          <Modal.Footer>\n            <button className=\"btn btn-primary\" onClick={(ev) => {\n              this.props.backend.giveConsentByPurpose(\n                ev,\n                this.props.activeDecl!.services,\n                this.props.activeDecl!.clientId,\n                this.props.activeDecl!.purposeDeclarationId\n              );\n              this.toggleSignPopup();\n              this.showReturnPopup(true, this.props.activeDecl!.clientId);\n            }}>Allkirjasta</button>\n            <Button variant=\"secondary\" onClick={(ev:any) => this.toggleSignPopup()}>\n              Tagasi\n            </Button>\n          </Modal.Footer>\n        </Modal>\n        <Button variant=\"primary\" className=\"mr-2\" onClick={(ev:any) => this.toggleSignPopup()}>\n          Anna nõusolek\n        </Button>\n        <Button variant=\"secondary\" onClick={(ev:any) => window.close()}>\n          Ei anna nõusolekut\n        </Button>\n      </>\n    );\n  }\n\n  ReturnScreen() {\n    return (\n    <div>\n      <h4>Nõusolek { business(this.state.savedClientId!, \"name\") }-le on antud!</h4>\n      <p>Kõiki oma antud nõusolekuid näed ja saad hallata siit <a href=\"/ui/csui\" onClick={this.showConsentTab}>Minu nõusolekud</a></p>\n      <button className=\"btn btn-primary\" onClick={() => {\n          window.close();\n          this.showReturnPopup(false);\n        }}>Tagasi teenusesse</button>\n    </div>\n    );\n  }\n\n  render() {\n\n    const activeDecl = this.props.activeDecl;\n\n    if (activeDecl === undefined) {\n      if (this.state.returnPopup) {\n        return this.ReturnScreen();\n      } else {\n        return (<div>Avatud taotlust pole.</div>);\n      }\n    }\n\n    return (\n        <div className=\"tab-info\">\n          <h4 className=\"mb-4 title\">{ business(activeDecl.clientId, \"name\") } ({ business(activeDecl.clientId, \"ntr\") }) küsib nõusolekute järgmistel tingimustel:</h4>\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-baseline\">\n                  <div><h4>Kirjeldus</h4></div>\n                  <div>\n                    { renderText(activeDecl.description) }\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-end\">\n                  <div><h4>Kehtivus</h4></div>\n                  <div>{activeDecl.validUntil && `Kehtib kuni: ${ formatTimestamp(activeDecl.validUntil)}`}</div>\n                </div>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col-md\">\n                <div className=\"d-flex align-items-end\">\n                  <div><h4>Nõusoleku alusel saab { business(activeDecl.clientId, \"name\") } Sinu kohta järgmised andmed:</h4></div>\n                  <div>\n                    {\n                      activeDecl.services.map(sdref => {\n                        const sd = this.props.backend.getServiceDeclaration(sdref);\n                        if (sd === undefined) {\n                          return <></>;\n                        }\n                        return (\n                          <>\n                            <h4>{sd.name}</h4>\n                            { renderText(sd.description) }\n                          </>\n                        )\n                      })\n                    }\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div className=\"row\">\n              <div className=\"col-md mt-4 mb-2 text-muted\">\n                Antud nõusoleku saad igal ajal tühistada oma nõusolekute vaatest <a href=\"/ui/csui\" onClick={this.showConsentTab}>Minu nõusolekud</a>\n              </div>\n            </div>\n            <p className=\"mt-4\">\n              { this.Popover() }\n            </p>\n          </div>\n    );\n  }\n};\n\nconst MainView = ({backend, tabRef}: any) => {\n\n  let backendUse = backend.use();\n\n  if (backendUse === null || backendUse === undefined) {\n    return (\n      <>\n      <div className=\"section\">Wait, or reinit the client UI from the arena window... '{window.name}'</div>\n      </>\n    );\n  }\n\n  if (backendUse.mem!.ui.user === undefined) {\n    return LoginScreen();\n  }\n\n  const activeDecl = backendUse.getActivePurposeDeclaration();\n\n  return (\n    <Tabs ref={tabRef}>\n      <div label=\"Avatud taotlused\">\n        <ActivePurposeDeclaration label=\"Avatud taotlused\" backend={backendUse} activeDecl={activeDecl} tabRef={tabRef}/>\n      </div>\n      { MyConsents(backendUse) }\n      { ConsentHistory(backendUse) }\n    </Tabs>\n  )\n}\n\n\n\nexport class CSEnduserUI extends React.PureComponent<{}, ConsentServiceBackend> {\n  backendLink: BackendStateUpdater<ConsentServiceState, ConsentServiceBackend>;\n  backend: Backend;\n  ref: React.RefObject<any>;\n\n  constructor(props: any, context?: any) {\n    super(props, context);\n    this.backendLink = new BackendStateUpdater(csb => { this.setState(csb as ConsentServiceBackend); }, ConsentServiceBackend);\n    this.backend = new Backend();\n    this.ref = React.createRef();\n  }\n\n  componentDidMount() {\n    if (process.env.NODE_ENV === \"development\") {\n      require('../../../static/css/mta_visuaal.css');\n    }\n    document.body.classList.add('temp');\n    this.backendLink.resetState();\n  }\n\n  render() {\n    return (\n      <CSBackend.Provider value={this.state}>\n        <VeeraLayout backend={this.backend}>\n          <MainView backend={this.backend} tabRef={this.ref} />\n        </VeeraLayout>\n      </CSBackend.Provider>\n    );\n  }\n}\n\nexport function formatTimestamp(timestamp : number, withTime? : boolean) {\n  if (withTime) {\n    return Intl.DateTimeFormat(\n      'et',\n      {\n        year : 'numeric',\n        month : 'numeric',\n        day : 'numeric',\n        hour : 'numeric',\n        minute : 'numeric',\n        second : 'numeric'\n      }\n    ).format(new Date(timestamp*1000));\n  }\n  return Intl.DateTimeFormat('et').format(new Date(timestamp*1000));\n}\n","import React from 'react';\nimport { BackendStateUpdater } from '../../../postMessage';\nimport { ConsentServiceState } from '../types';\nimport { ConsentServiceBackend, Backend, CSBackend } from './backendAPI';\n\n\nexport class Ria extends React.PureComponent<{}, ConsentServiceBackend> {\n  backendLink: BackendStateUpdater<ConsentServiceState, ConsentServiceBackend>;\n  backend: Backend;\n\n  constructor(props: any, context?: any) {\n    super(props, context);\n    this.backendLink = new BackendStateUpdater(csb => { this.setState(csb as ConsentServiceBackend); }, ConsentServiceBackend);\n    this.backend = new Backend();\n  }\n\n  componentDidMount() {\n    if (process.env.NODE_ENV === \"development\") {\n      require('../../../static/assets/tara/main.css');\n    }\n    this.backendLink.resetState();\n  }\n\n  render() {\n    return (\n      <CSBackend.Provider value={this.state}>\n        <MainView backend={this.backend} />\n      </CSBackend.Provider>\n    )\n  }\n\n}\n\nconst MainView = ({backend}: any) => {\n  let backendUse = backend.use();\n  if (!backendUse) return (<p>Backend failed, close and reopen window.</p>)\n  let click = (ev: React.MouseEvent<HTMLButtonElement>) => {\n    ev.preventDefault();\n    backendUse.login(ev, (ev.currentTarget.form!.elements[0] as any).value)\n    window.location.href = \"/ui/csui\";\n  }\n  return(\n    <div className=\"c-layout\">\n      <div className=\"c-layout--full\">\n        <div className=\"c-header-bar\">\n          <div className=\"container\">\n            <div className=\"d-flex justify-content-between align-items-center\">\n              <header role=\"banner\">\n                <h1 aria-label=\"Riigi autentimisteenus\" aria-hidden=\"true\"></h1>\n                <p aria-label=\"Turvaline autentimine asutuste e-teenustes\">Turvaline autentimine asutuste e-teenustes</p>\n              </header>\n            </div>\n          </div>\n        </div>\n        <div className=\"c-header\">\n          <div className=\"container\">\n            <div className=\"c-header__logo\">\n              <div className=\"c-header__logo-link\">\n              <img src={require('./../../../static/assets/tara/tara-logo-et.png')} aria-hidden=\"true\" alt=\"\" /></div>\n            </div>\n          </div>\n        </div>\n        <div className=\"container\">\n          <div className=\"c-tab-login\">\n            <main role=\"main\" className=\"c-tab-login__main\">\n              <div className=\"c-tab-login__content is-active\" data-tab=\"mobile-id\" aria-hidden=\"false\">\n                <div className=\"c-tab-login__content-wrap\">\n                  <div className=\"c-tab-login__content-icon\">\n                    <svg role=\"img\" aria-label=\"\" className=\"icon icon-mobile-id\"><use href=\"#icon-mobile-id\"></use></svg>\n                  </div>\n                <div className=\"c-tab-login__content-text\">\n                  <div role=\"heading\">\n                    <h2>Mobiil-ID</h2>\n                  </div>\n                  <p>Sisselogimiseks vajate kehtivat Mobiil-ID lepingut. Sisenemiseks Mobiil-ID-ga sisestage oma isikukood ja telefoninumber. Seejärel saadetakse Teie mobiiltelefonile kontrollsõnum.</p>\n                  <form>\n                    <table>\n                      <tbody>\n                        <tr>\n                          <td className=\"col-label\">\n                            <label htmlFor=\"mid-personal-code\" className=\"form-label\">Isikukood</label>\n                          </td>\n                          <td>\n                            <div className=\"input-group\">\n                              <div className=\"input-group-prepend\">\n                                <span className=\"input-group-text\">EE</span>\n                              </div>\n                              <input type=\"text\" id=\"mid-personal-code\" className=\"form-control\" name=\"principalCode\" defaultValue=\"47302200234\" />\n                            </div>\n                          </td>\n                          </tr>\n                          <tr>\n                            <td className=\"col-label\">\n                              <label htmlFor=\"mid-phone-number\" className=\"form-label\">Telefoninumber</label>\n                            </td>\n                            <td>\n                              <div className=\"input-group\">\n                                <div className=\"input-group-prepend\">\n                                  <span className=\"input-group-text\">+372</span>\n                                </div>\n                                <input type=\"tel\" id=\"mid-phone-number\" className=\"form-control\" name=\"mobileNumber\" defaultValue=\"53883333\" /></div>\n                              </td>\n                            </tr>\n                            <tr>\n                              <td></td>\n                              <td>\n                                <button className=\"c-btn c-btn--primary\" onClick={(ev) => click(ev)}>Jätkan</button>\n                              </td>\n                            </tr>\n                          </tbody>\n                        </table>\n                      </form>\n                    </div>\n                  </div>\n                  <div className=\"c-tab-login__footer\">\n                    <p><a href=\"https://tim.www.eesti.ee/tim/cancel-auth\">Tagasi teenusepakkuja juurde</a></p>\n                    <p>\n                      <a href=\"https://www.id.ee/?id=35803&amp;group_id=1\" target=\"_blank\" rel=\"noopener noreferrer\">Abi id.ee lehelt</a>\n                    </p>\n                  </div>\n                </div>\n              </main>\n            </div>\n          </div>\n          <p className=\"link-back-mobile\">\n            <a href=\"https://tim.www.eesti.ee/tim/cancel-auth\">Tagasi teenusepakkuja juurde</a>\n          </p>\n          <svg aria-hidden=\"true\" className=\"c-inline-svg__hidden\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\">\n            <defs>\n            <symbol id=\"icon-mobile-id\" viewBox=\"0 0 20 32\">\n            <title>mobile-id</title>\n            <path d=\"M7.218 28.027h5.476v1.12h-5.476zM15.876 31.68h-12.089c-0 0-0 0-0 0-1.8 0-3.261-1.454-3.271-3.252v-24.854c0.005-1.803 1.468-3.262 3.271-3.262 0 0 0 0 0 0h12.089c0 0 0 0 0 0 1.803 0 3.266 1.459 3.271 3.262v24.845c-0.005 1.803-1.468 3.262-3.271 3.262 0 0 0 0 0 0v0zM3.787 1.422c0 0 0 0-0 0-1.19 0-2.155 0.962-2.16 2.151v22.045h16.409v-22.044c0 0 0 0 0-0 0-1.188-0.963-2.151-2.151-2.151-0.003 0-0.006 0-0.009 0h0zM1.627 28.418c0.005 1.189 0.97 2.151 2.16 2.151 0 0 0 0 0 0h12.089c0 0 0 0 0 0 1.19 0 2.155-0.962 2.16-2.151v-1.689h-16.409zM12.382 8.951c-0.721-0.218-1.55-0.343-2.408-0.343-0.544 0-1.076 0.050-1.592 0.147l0.053-0.008c-0.018 0.004-0.039 0.006-0.060 0.006-0.154 0-0.282-0.108-0.313-0.252l-0-0.002c-0.009-0.089 0-0.169 0.053-0.231 0.047-0.068 0.119-0.117 0.202-0.133l0.002-0c0.494-0.094 1.063-0.147 1.644-0.147 0.922 0 1.813 0.135 2.653 0.386l-0.065-0.017c0.132 0.040 0.226 0.16 0.226 0.302 0 0.174-0.141 0.315-0.315 0.315-0.032 0-0.062-0.005-0.091-0.013l0.002 0.001zM14.187 11.396c-0 0-0.001 0-0.001 0-0.066 0-0.127-0.020-0.178-0.054l0.001 0.001c-1.129-0.791-2.531-1.263-4.043-1.263-1.375 0-2.659 0.391-3.747 1.067l0.030-0.017c-0.049 0.032-0.109 0.051-0.174 0.051-0.113 0-0.213-0.059-0.27-0.148l-0.001-0.001c-0.033-0.049-0.053-0.108-0.053-0.173 0-0.116 0.064-0.217 0.158-0.271l0.002-0.001c1.151-0.716 2.547-1.141 4.043-1.141 1.65 0 3.18 0.517 4.435 1.397l-0.025-0.016c0.142 0.089 0.178 0.293 0.089 0.436-0.059 0.081-0.153 0.133-0.26 0.133-0.002 0-0.005-0-0.007-0h0zM5.236 13.92c-0.176-0.001-0.318-0.144-0.318-0.32 0-0.070 0.023-0.135 0.061-0.188l-0.001 0.001c1.147-1.527 2.954-2.505 4.99-2.505 1.961 0 3.709 0.907 4.85 2.324l0.009 0.012c0.107 0.142 0.089 0.338-0.053 0.444-0.053 0.041-0.121 0.066-0.195 0.066-0.101 0-0.19-0.046-0.249-0.119l-0-0.001c-1.035-1.279-2.604-2.090-4.364-2.090-1.826 0-3.448 0.874-4.471 2.227l-0.010 0.014c-0.057 0.078-0.146 0.13-0.248 0.133l-0.001 0zM5.556 17.138c-0.003 0-0.006 0-0.009 0-0.172 0-0.311-0.139-0.311-0.311 0-0 0-0 0-0v0-0.018c0.161-2.486 2.216-4.441 4.728-4.441 2.137 0 3.943 1.415 4.534 3.358l0.009 0.034c0.004 0.018 0.006 0.039 0.006 0.061 0 0.177-0.143 0.32-0.32 0.32-0.128 0-0.238-0.075-0.289-0.183l-0.001-0.002v-0.018c-0.511-1.722-2.079-2.956-3.936-2.956-2.181 0-3.963 1.703-4.091 3.852l-0.001 0.011c-0.010 0.164-0.145 0.293-0.311 0.293-0.003 0-0.007-0-0.010-0h0zM7.004 19.387c-0.176-0-0.319-0.144-0.319-0.32 0-0.025 0.003-0.050 0.008-0.073l-0 0.002c0.082-0.236 0.129-0.507 0.129-0.79 0-0.116-0.008-0.231-0.023-0.343l0.001 0.013c-0.085-0.277-0.134-0.596-0.134-0.926 0-1.802 1.461-3.262 3.262-3.262 1.579 0 2.896 1.122 3.197 2.612l0.004 0.021c0.142 0.587 0.213 1.182 0.204 1.778 0 0.178-0.142 0.32-0.32 0.32-0.17-0.005-0.306-0.141-0.311-0.311v-0c0-0.551-0.062-1.102-0.178-1.636-0.291-1.16-1.325-2.005-2.556-2.005-1.453 0-2.631 1.178-2.631 2.631 0 0.222 0.028 0.439 0.080 0.645l-0.004-0.018c0.080 0.329 0.044 0.809-0.107 1.422-0.036 0.137-0.157 0.236-0.302 0.24h-0zM8.311 20.151l-0.089-0.009c-0.128-0.041-0.219-0.158-0.219-0.297 0-0.034 0.005-0.066 0.015-0.096l-0.001 0.002c0.169-0.456 0.266-0.982 0.266-1.531 0-0.244-0.019-0.483-0.056-0.717l0.003 0.026c-0.059-0.17-0.093-0.367-0.093-0.571 0-0.992 0.804-1.796 1.796-1.796 0.892 0 1.632 0.65 1.772 1.503l0.001 0.010c0.213 0.836 0.222 1.804 0.027 2.88-0.001 0.176-0.144 0.319-0.32 0.319s-0.32-0.143-0.32-0.32c0-0.038 0.007-0.074 0.018-0.107l-0.001 0.002c0.178-0.987 0.169-1.867-0.018-2.631-0.128-0.51-0.583-0.882-1.124-0.882-0.639 0-1.158 0.518-1.158 1.158 0 0.098 0.012 0.193 0.035 0.284l-0.002-0.008c0.16 0.64 0.089 1.502-0.222 2.56-0.043 0.13-0.163 0.222-0.305 0.222-0.002 0-0.005-0-0.007-0h0zM9.804 20.329c-0.172-0.005-0.31-0.147-0.31-0.32 0-0.025 0.003-0.050 0.008-0.073l-0 0.002c0.159-0.552 0.256-1.187 0.267-1.843l0-0.006c0-0.311-0.036-0.622-0.107-0.916-0.001-0.008-0.001-0.017-0.001-0.026 0-0.177 0.143-0.32 0.32-0.32 0.131 0 0.244 0.079 0.294 0.192l0.001 0.002c0.089 0.356 0.124 0.711 0.116 1.067-0.010 0.716-0.113 1.403-0.298 2.056l0.014-0.056c-0.036 0.137-0.157 0.236-0.302 0.24h-0z\"></path>\n          </symbol>\n          </defs>\n        </svg>\n      </div>\n    </div>\n  )\n}","import React, { Suspense } from 'react';\nimport './App.css';\nimport { BrowserRouter as Router, Switch, Route } from \"react-router-dom\";\nimport { Theatre } from './components/Theatre';\nimport { useTranslation } from 'react-i18next';\nimport { CSEnduserUI } from './process/consentService/altUI/CSEnduserUI';\nimport { Ria } from './process/consentService/altUI/ria';\n\nconst Page = () => {\n  const { i18n } = useTranslation();\n\n  const changeLanguage = (lng: string) => {\n    i18n.changeLanguage(lng);\n  };\n\n  return (\n    <div className=\"App\">\n        <Router>\n          <Switch>\n            <Route path=\"/ui/ria\">\n              <Ria/>\n            </Route>\n            <Route path=\"/ui/csui\">\n              <CSEnduserUI/>\n            </Route>\n            <Route path=\"/\">\n              <nav className=\"navbar navbar-light bg-light mb-4\">\n                <span className=\"navbar-brand\">\n                  <img alt=\"logo\" src={require('./logo.svg')} width=\"40\" />\n                </span>\n                <div className=\"language\">\n                  <a href=\"#!\"\n                    onClick={(e) => {e.preventDefault(); changeLanguage('et')}}\n                    className={ i18n.language === 'et' ? 'active': '' }>et</a>\n                  <a href=\"#!\"\n                    onClick={(e) => {e.preventDefault(); changeLanguage('en')}}\n                    className={ i18n.language === 'en' || i18n.language === 'en-US' ? 'active': '' }>en</a>\n                </div>\n              </nav>\n              <div className=\"container-fluid\">\n                <Theatre/>\n              </div>\n            </Route>\n          </Switch>\n        </Router>\n    </div>\n  );\n}\n\n// loading component for suspense fallback\nconst Loader = () => (\n  <div className=\"App\">\n    <div>loading...</div>\n  </div>\n);\n\nconst App: React.FC = () => {\n  return (\n    <Suspense fallback={<Loader />}>\n      <Page />\n    </Suspense>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import { createStore, combineReducers, applyMiddleware } from \"redux\";\nimport thunkMiddleware from \"redux-thunk\";\nimport { composeWithDevTools } from \"redux-devtools-extension\";\n\nimport { queueListener } from \"./components/Arena\";\nimport { reduceTheatre } from \"./components/Theatre\";\nimport { registerGlobalListener } from \"./postMessage\";\n\nconst rootReducer = combineReducers({\n\ttheatre: reduceTheatre,\n});\n\n\nexport type AppState = ReturnType<typeof rootReducer>;\n\nexport default function configureStore() {\n\t  const middlewares = [thunkMiddleware];\n\t  const middleWareEnhancer = applyMiddleware(...middlewares);\n\n\t  const store = createStore(\n\t\t      rootReducer,\n\t\t      composeWithDevTools(middleWareEnhancer)\n\t  );\n\n\tstore.subscribe(() => queueListener(store));\n\n\tregisterGlobalListener(store);\n\n\treturn store;\n}\n\n\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport { Provider } from \"react-redux\";\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\nimport configureStore from './store';\nimport './i18n';\n\nconst store = configureStore();\n\nReactDOM.render(<Provider store={store}><App /></Provider>, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","module.exports = __webpack_public_path__ + \"static/media/user-icon.bdeaa261.svg\";","module.exports = __webpack_public_path__ + \"static/media/login.9f370677.svg\";"],"sourceRoot":""}